(function(B,q){function u(){x+=1;return"i"+x}function v(b,d){var f,g,h,e;f=d.split(".");e=b;g=0;for(h=f.length;g<h;g+=1){e=e[f[g]];if(e===q)return q}return e}function y(b,d,f){d=d.split(".");var g=d.length-1,h=b;for(b=0;b<g;b+=1){h=h[d[b]];if(h===q)return}h[d[g]]=f}function z(b,d){var f,g=b.length,h,e;for(f=0;f<g;f+=1)if(typeof b[f].length==="number"){h=0;for(e=b[f].length;h<e;h+=1)d(b[f][h])}else d(b[f])}var p={version:"0.0.1"},x=0,C=/^\s+/,D=/\s+$/,t={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",
receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined."};p.rule=function(b){function d(a,c,i){if(a)f[c]=function(j){var m,n;if(typeof a==="string")return i?
a.indexOf(j)===0:a===j;if(typeof a==="object"&&a.length){m=0;for(n=a.length;m<n;m+=1)if(i?a[m].indexOf(j)===0:a===j[m])return true;return false}return true}}var f={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],e=[false,true,false],k,l;f.receiverId=b.receiverId;f.path=b.path;k=0;for(l=g.length;k<l;k+=1)d(b[g[k]],h[k],e[k]);f.transformData=function(a,c){var i;if(a!==q&&typeof c==="string"&&typeof b.path==="string"&&b.path.length>c.length){i=c.length;return v(a,b.path.slice(i>
0?i+1:i))}return a};return f};p.trigger=function(b){var d={},f=b.id,g=b.engine,h=b.processor,e=b.processorArgs,k=b.signal;d.receiveMessage=function(){var l=[],a,c=e.length;for(a=0;a<c;a+=1)l.push(g.get(e[a]));l=h.apply(q,l);g.sendMessage({senderId:f,signal:k,data:l})};g.addReceiver(f,d);return d};p.engine=function(){function b(a,c){if(typeof a!=="string")throw Error(t.receiverIdMustBeString);if(!c||typeof c!=="function"&&typeof c.receiveMessage!=="function")throw Error(t.noReceiveMessageMethod);if(a in
h)throw Error(t.notUniqueReceiverId);h[a]=typeof c!=="function"?c:{receiveMessage:c}}function d(a){if(typeof a.receiverId!=="string")throw Error(t.noReceiverId);e.push(p.rule(a))}function f(a){a.engine=g;k.push(p.trigger(a))}var g={},h={},e=[],k=[],l=[];g.addReceiver=b;g.addRule=d;g.addRules=function(){z(arguments,d)};g.addTrigger=f;g.addTriggers=function(){z(arguments,f)};g.addModel=function(a){l.push(a)};g.sendMessage=function(a){var c,i=e.length,j;for(c=0;c<i;c+=1){j=e[c];if(a.senderId!==j.receiverId)if((!j.checkSender||
j.checkSender(a.senderId))&&(!j.checkPath||j.checkPath(a.path))&&(!j.checkSignal||j.checkSignal(a.signal))){if(!(j.receiverId in h))throw Error(t.receiverNotFound);h[j.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:j.path,signal:a.signal,data:j.transformData(a.data,a.path)})}}};g.get=function(a){var c,i,j;c=0;for(i=l.length;c<i;c+=1){j=l[c].get(a);if(j!==q)return j}return q};g.subscribe=function(a,c){var i=u();b(i,c);a.receiverId=i;d(a)};return g};p.model=function(b){function d(a,
c){var i,j,m,n,o,s={},r=true;if(typeof a!=="string")a="";i=0;for(j=l.length;i<j;i+=1){m=l[i];if(!(a&&m.path.indexOf(a)!==0)){s.hasOwnProperty(m.path)||(s[m.path]=[]);n=p.validators[m.validatorName];n=n(v(k,m.path),m.properties||{});if(n!==q){s[m.path].push(n);r=false}}}if(!c)for(o in s)s.hasOwnProperty(o)&&e.sendMessage({senderId:h,path:o,signal:"error",data:s[o]});return r}function f(a,c){e.sendMessage({senderId:h,path:a,signal:"value",data:c})}b=b||{};var g={},h=b.id||u(),e=b.engine,k={},l=(b.metadata||
{}).validationRules||[];g.receiveMessage=function(a){if(a.signal==="value"&&typeof a.path==="string"){y(k,a.path,a.data);d(a.path)}};g.set=function(){if(arguments.length===1){k=arguments[0];f("",k)}else{var a=arguments[0],c=arguments[1];y(k,a,c);f(a,c)}};g.get=function(a){if(a===q)return k;return v(k,a)};g.validate=d;if(e){e.addReceiver(h,g);e.addRule({receiverId:h,signal:"value"});e.addModel(g)}return g};p.validators={};p.validators.required=function(b,d){if(b===q||b===null||typeof b==="string"&&
(b===null||b===q?"":b.toString().replace(C,"").replace(D,""))===""||typeof b==="number"&&isNaN(b))return d.message||"This field is required!";return q};p.view=function(b){function d(l){var a=(h[l.typeName]||e)({metadata:l,engine:g}),c,i;k[a.id]=a;if(l.children&&l.children.length){c=0;for(i=l.children.length;c<i;c+=1)a.children.push(d(l.children[c]))}return a}var f={},g=b.engine,h=b.elementTypes,e=b.defaultElementType||p.element,k={};f.element=d(b.metadata);f.initialize=function(){f.element.initialize()};
f.getElementById=function(l){return k[l]};return f};p.element=function(b){var d={},f=b.engine;b=b.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly"};d.id=b.id||u();d.properties=b.properties||{};d.children=[];d.initialize=function(){};d.receiveMessage=function(h){var e=g[h.signal];e&&typeof d[e]==="function"&&d[e](h.data)};d.notifyValueChange=function(h){var e=d.properties.binding;if(typeof e==="string")f.sendMessage({senderId:d.id,path:e,signal:"value",data:h});else throw Error(t.elementWithoutBinding);
};d.eachChild=function(h){var e,k;e=0;for(k=d.children.length;e<k;e+=1)h(d.children[e],e)};f.addReceiver(d.id,d);return d};p.metadataProvider=function(b){function d(a,c){var i,j,m,n,o;c=c||h;c.id=a.id||u();c.typeName=a.typeName;c.properties=a.properties||{};if(a.children&&a.children.length){c.children=[];i=0;for(j=a.children.length;i<j;i+=1){m={};d(a.children[i],m);c.children.push(m)}}if(typeof a.binding==="string"){e.push({receiverId:c.id,path:a.binding,signal:"value"});c.properties.binding=a.binding}i=
0;for(j=l.length;i<j;i+=1){m=l[i];n=a[m];if(typeof n==="string"){n=n;o={args:[]};var s=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,w=n;r=void 0;for(var A=void 0;(r=s.exec(n))!==null;)o.args.push(r[0]);r=0;for(A=o.args.length;r<A;r+=1)w=w.replace(o.args[r],"arguments["+r+"]");o.processor=new Function("return "+w+";");n=o;o=u();k.push({id:o,processorArgs:n.args,processor:n.processor,signal:m});e.push({receiverId:o,path:n.args,signal:"value"});e.push({receiverId:c.id,senderId:o,signal:m})}}}
var f={},g=[],h={},e=[],k=[],l=["hidden","readonly"];f.getModelMetadata=function(){return g};f.getViewMetadata=function(){return h};f.getRules=function(){return e};f.getTriggers=function(){return k};d(b.metadata);return f};B.fe=p})(function(){return this}());
