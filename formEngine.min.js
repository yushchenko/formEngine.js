(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var f,c,g,j;f=d.split(".");j=a;c=0;for(g=f.length;c<g;c+=1){j=j[f[c]];if(j===n||j===null)return n}return j}function A(a,d,f){d=d.split(".");var c=d.length-1,g=a;for(a=0;a<c;a+=1){g=g[d[a]];if(g===n)return}g[d[c]]=f}function B(a,d){var f,c=a.length,g,j;for(f=0;f<c;f+=1)if(typeof a[f].length==="number"){g=0;for(j=a[f].length;g<j;g+=1)d(a[f][g])}else d(a[f])}function w(a,d){var f;a=a||"";for(f in d)if(d.hasOwnProperty(f))a=a.replace(RegExp("{"+
f+"}","g"),d[f]);return a}var k={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};k.dsl={};k.dsl.defaultMethods={id:function(a){this.element.id=a;return this.chain},property:function(a,d){this.element.properties[a]=d;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){return this.element}};k.dsl.token=function(a,d){function f(c,g,j){function h(b,e){c[b]=function(){return e.apply(j,arguments)}}for(var i in g)g.hasOwnProperty(i)&&h(i,g[i])}return function(){function c(){var h,i=arguments.length,b;for(h=0;h<i;h+=1){b=arguments[h];if(typeof b==="function"&&typeof b.get==="function")g.elements.push(b.get());else if(h===0&&typeof b==="string")g.binding=b}return c}var g={properties:{},validationRules:{},elements:[]};if(typeof a==="function")a(g);
else if(typeof a==="string")g.typeName=a;var j={element:g,chain:c};f(c,k.dsl.defaultMethods,j);f(c,d||{},j);return c.apply(n,arguments)}};k.dsl.element=k.dsl.token();k.rule=function(a){function d(b,e,m){if(b)f[e]=function(l){var o,q;if(typeof b==="string")return m?b.indexOf(l)===0:b===l;if(typeof b==="object"&&b.length){o=0;for(q=b.length;o<q;o+=1)if(m?b[o].indexOf(l)===0:b[o]===l)return true;return false}return true}}var f={},c=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],
j=[false,true,false],h,i;f.receiverId=a.receiverId;f.path=a.path;h=0;for(i=c.length;h<i;h+=1)d(a[c[h]],g[h],j[h]);f.transformData=function(b,e){var m;if(b!==n&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){m=e.length;return y(b,a.path.slice(m>0?m+1:m))}return b};return f};k.trigger=function(a){var d={},f=a.id,c=a.engine,g=a.processor,j=a.processorArgs,h=a.signal;d.receiveMessage=function(){var i=[],b,e=j.length;for(b=0;b<e;b+=1)i.push(c.get(j[b]));i=g.apply(n,i);c.sendMessage({senderId:f,
signal:h,data:i})};c.addReceiver(f,d);return d};k.engine=function(){function a(b,e){if(typeof b!=="string")throw Error(u.receiverIdMustBeString);if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(b in g)throw Error(u.notUniqueReceiverId);g[b]=typeof e!=="function"?e:{receiveMessage:e}}function d(b){if(typeof b.receiverId!=="string")throw Error(u.noReceiverId);j.push(k.rule(b))}function f(b){b.engine=c;h.push(k.trigger(b))}var c={},g={},j=[],
h=[],i=[];c.addReceiver=a;c.addRule=d;c.addRules=function(){B(arguments,d)};c.addTrigger=f;c.addTriggers=function(){B(arguments,f)};c.addModel=function(b){i.push(b)};c.sendMessage=function(b){var e,m=j.length,l;for(e=0;e<m;e+=1){l=j[e];if(b.senderId!==l.receiverId)if((!l.checkSender||l.checkSender(b.senderId))&&(!l.checkPath||l.checkPath(b.path))&&(!l.checkSignal||l.checkSignal(b.signal))){if(!(l.receiverId in g))throw Error(u.receiverNotFound);g[l.receiverId].receiveMessage({senderId:b.senderId,
path:b.path,rulePath:l.path,signal:b.signal,data:l.transformData(b.data,b.path)})}}};c.get=function(b){var e,m,l;e=0;for(m=i.length;e<m;e+=1){l=i[e].get(b);if(l!==n)return l}return n};c.subscribe=function(b,e){var m=t();a(m,e);b.receiverId=m;d(b)};return c};k.validationRule=function(a){var d={},f=a.id||t(),c=a.engine,g=a.path,j=k.validators[a.validatorName],h=a.validatorProperties||{},i;d.receiveMessage=function(b){if(b.signal==="validation-inactive")i=b.data};d.validate=function(b){if(i)return n;
b=y(b,g);return j(b,h)};d.path=g;c.addReceiver(f,d);return d};k.model=function(a){function d(b,e){var m,l,o,q,s,p={},r=true;if(typeof b!=="string")b="";m=0;for(l=i.length;m<l;m+=1){o=i[m];if(!(b&&o.path.indexOf(b)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(h);if(q!==n){p[o.path].push(q);r=false}}}if(!e)for(s in p)p.hasOwnProperty(s)&&j.sendMessage({senderId:g,path:s,signal:"error",data:p[s]});return r}function f(b,e){j.sendMessage({senderId:g,path:b,signal:"value",data:e})}a=a||{};
var c={},g=a.id||t(),j=a.engine,h={},i=[];c.receiveMessage=function(b){if(b.signal==="value"&&typeof b.path==="string"){A(h,b.path,b.data);d(b.path)}};c.set=function(){if(arguments.length===1){h=arguments[0];f("",h)}else{var b=arguments[0],e=arguments[1];A(h,b,e);f(b,e)}};c.get=function(b){if(b===n)return h;return y(h,b)};c.validate=d;(function(){var b=(a.metadata||{}).validationRules||[],e,m=b.length,l;for(e=0;e<m;e+=1){l=b[e];i.push(k.validationRule({id:l.id,engine:j,path:l.path,validatorName:l.validatorName,
validatorProperties:l.validatorProperties}))}})();j.addReceiver(g,c);j.addRule({receiverId:g,signal:"value"});j.addModel(c);return c};k.validators={};k.validators.required=function(a,d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||k.validationMessages.required,d);return n};k.dsl.defaultMethods.required=function(a){this.element.validationRules.required=a||true;return this.chain};k.validators.minLength=
function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||k.validationMessages.minLenght,d);return n};k.validators.minLength.defaultProperty="length";k.dsl.defaultMethods.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};k.validators.maxLength=function(a,d){if(a&&a.length!==n&&a.length>d.length)return w(d.message||k.validationMessages.maxLenght,d);return n};k.validators.maxLength.defaultProperty="length";k.dsl.defaultMethods.maxLength=function(a){this.element.validationRules.maxLength=
a;return this.chain};k.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||k.validationMessages.minValue,d);return n};k.validators.minValue.defaultProperty="value";k.dsl.defaultMethods.minValue=function(a){this.element.validationRules.minValue=a;return this.chain};k.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||k.validationMessages.maxValue,d);return n};k.validators.maxValue.defaultProperty="value";k.dsl.defaultMethods.maxValue=function(a){this.element.validationRules.maxValue=
a;return this.chain};k.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};k.view=function(a){function d(i){var b=(g[i.typeName]||j)({metadata:i,engine:c}),e,m;h[b.id]=b;if(i.elements&&i.elements.length){e=0;for(m=i.elements.length;e<m;e+=1)b.addElement(d(i.elements[e]))}return b}
var f={},c=a.engine,g=a.elementTypes,j=a.defaultElementType||k.element,h={};f.element=d(a.metadata);f.initialize=function(){f.element.initialize()};f.getElementById=function(i){return h[i]};return f};k.element=function(a){function d(){g.sendMessage({senderId:c.id,signal:"validation-inactive",data:c.isHidden()||c.isReadonly()});f(function(h){h.notifyValidationStatusChange()})}function f(h){var i,b;i=0;for(b=c.elements.length;i<b;i+=1)h(c.elements[i],i)}var c={},g=a.engine;a=a.metadata||{};var j={value:"setValue",
hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=a.id||t();c.properties=a.properties||{};c.elements=[];c.parent=n;c.initialize=function(){};c.addElement=function(h){c.elements.push(h);h.parent=c};c.receiveMessage=function(h){var i=j[h.signal];i&&typeof c[i]==="function"&&c[i](h.data)};c.setValue=void 0;c.notifyValueChange=function(h){var i=c.properties.binding;if(typeof i==="string")g.sendMessage({senderId:c.id,path:i,signal:"value",data:h});else throw Error(u.elementWithoutBinding);
};c.setHidden=function(h){c.hidden=h;d()};c.setReadonly=function(h){c.readonly=h;d()};c.isHidden=function(){return!!c.hidden||c.parent&&c.parent.isHidden()};c.isReadonly=function(){return!!c.readonly};c.notifyValidationStatusChange=d;c.showErrors=function(){};c.eachChild=f;g.addReceiver(c.id,c);return c};k.expressionParser=function(a){for(var d={args:[]},f=[],c=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,g,j=a;(g=c.exec(a))!==null;){f.push(g[0]);d.args.push(g[1])}a=0;for(c=f.length;a<c;a+=
1)j=j.replace(f[a],"arguments["+a+"]");d.processor=new Function("return "+j+";");return d};k.metadataProvider=function(a){function d(e,m){var l,o,q;m=m||g;m.id=e.id||t();m.typeName=e.typeName;m.properties=e.properties||{};q=m;var s,p,r,v,x,C;s=0;for(p=i.length;s<p;s+=1){r=i[s];v=e[r];if(typeof v==="string"){v=b(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};h.push(C);j.push({receiverId:x,path:v.args,signal:"value"});j.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof e.binding===
"string"){m.properties.binding=e.binding;q=m;s=e.binding;p=e.validationRules||{};for(l in p)if(p.hasOwnProperty(l)){r=k.validators[l];if(r===n)throw Error(u.unknownValidator+l);if(typeof p[l]==="object")o=p[l];else if(typeof r.defaultProperty==="string"){o={};o[r.defaultProperty]=p[l]}r=t();c.validationRules.push({id:r,path:s,validatorName:l,validatorProperties:o});j.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}j.push({receiverId:m.id,path:e.binding,signal:["value","error"]})}if(e.elements&&
e.elements.length){m.elements=[];l=0;for(o=e.elements.length;l<o;l+=1){q={};d(e.elements[l],q,m);m.elements.push(q)}}}var f={},c={validationRules:[]},g={},j=[],h=[],i=a.expressionProperties||["value","hidden","readonly"],b=a.expressionParser||k.expressionParser;f.getModelMetadata=function(){return c};f.getViewMetadata=function(){return g};f.getRules=function(){return j};f.getTriggers=function(){return h};d(a.metadata);return f};D.fe=k})(function(){return this}());
