(function(A,p){function t(){w+=1;return"i"+w}function u(b,c){var d,i,g,e;d=c.split(".");e=b;i=0;for(g=d.length;i<g;i+=1){e=e[d[i]];if(e===p)return p}return e}function x(b,c,d){c=c.split(".");var i=c.length-1,g=b;for(b=0;b<i;b+=1){g=g[c[b]];if(g===p)return}g[c[i]]=d}function y(b,c){var d,i=b.length,g,e;for(d=0;d<i;d+=1)if(typeof b[d].length==="number"){g=0;for(e=b[d].length;g<e;g+=1)c(b[d][g])}else c(b[d])}var m={version:"0.0.1"},w=0,B=/^\s+/,C=/\s+$/,s={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",
receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined."};m.rule=function(b){function c(a,f,j){if(a)d[f]=function(k){var n,o;if(typeof a==="string")return j?
a.indexOf(k)===0:a===k;if(typeof a==="object"&&a.length){n=0;for(o=a.length;n<o;n+=1)if(j?a[n].indexOf(k)===0:a===k[n])return true;return false}return true}}var d={},i=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],e=[false,true,false],l,h;d.receiverId=b.receiverId;d.path=b.path;l=0;for(h=i.length;l<h;l+=1)c(b[i[l]],g[l],e[l]);d.transformData=function(a,f){var j;if(a!==p&&typeof f==="string"&&typeof b.path==="string"&&b.path.length>f.length){j=f.length;return u(a,b.path.slice(j>
0?j+1:j))}return a};return d};m.trigger=function(b){var c={},d=b.id,i=b.engine,g=b.processor,e=b.processorArgs,l=b.signal;c.receiveMessage=function(){var h=[],a,f=e.length;for(a=0;a<f;a+=1)h.push(i.get(e[a]));h=g.apply(p,h);i.sendMessage({senderId:d,signal:l,data:h})};i.addReceiver(d,c);return c};m.engine=function(){function b(a,f){if(typeof a!=="string")throw Error(s.receiverIdMustBeString);if(!f||typeof f!=="function"&&typeof f.receiveMessage!=="function")throw Error(s.noReceiveMessageMethod);if(a in
g)throw Error(s.notUniqueReceiverId);g[a]=typeof f!=="function"?f:{receiveMessage:f}}function c(a){if(typeof a.receiverId!=="string")throw Error(s.noReceiverId);e.push(m.rule(a))}function d(a){a.engine=i;l.push(m.trigger(a))}var i={},g={},e=[],l=[],h=[];i.addReceiver=b;i.addRule=c;i.addRules=function(){y(arguments,c)};i.addTrigger=d;i.addTriggers=function(){y(arguments,d)};i.addModel=function(a){h.push(a)};i.sendMessage=function(a){var f,j=e.length,k;for(f=0;f<j;f+=1){k=e[f];if(a.senderId!==k.receiverId)if((!k.checkSender||
k.checkSender(a.senderId))&&(!k.checkPath||k.checkPath(a.path))&&(!k.checkSignal||k.checkSignal(a.signal))){if(!(k.receiverId in g))throw Error(s.receiverNotFound);g[k.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:k.path,signal:a.signal,data:k.transformData(a.data,a.path)})}}};i.get=function(a){var f,j,k;f=0;for(j=h.length;f<j;f+=1){k=h[f].get(a);if(k!==p)return k}return p};i.subscribe=function(a,f){var j=t();b(j,f);a.receiverId=j;c(a)};return i};m.model=function(b){function c(h,
a){g&&g.sendMessage({senderId:i,path:h,signal:"value",data:a})}b=b||{};var d={},i=b.id||t(),g=b.engine,e={},l=(b.metadata||{}).validationRules||[];d.receiveMessage=function(h){h.signal==="value"&&typeof h.path==="string"&&x(e,h.path,h.data)};d.set=function(){if(arguments.length===1){e=arguments[0];c("",e)}else{var h=arguments[0],a=arguments[1];x(e,h,a);c(h,a)}};d.get=function(h){if(h===p)return e;return u(e,h)};d.isValid=function(h){var a,f,j,k;a=0;for(f=l.length;a<f;a+=1){j=l[a];if(!(h&&j.path.indexOf(h)!==
0)){k=m.validators[j.validatorName];if(k(u(e,j.path),j.properties||{})!==p)return false}}return true};if(g){g.addReceiver(i,d);g.addRule({receiverId:i,signal:"value"});g.addModel(d)}return d};m.validators={};m.validators.required=function(b,c){if(b===p||b===null||typeof b==="string"&&(b===null||b===p?"":b.toString().replace(B,"").replace(C,""))===""||typeof b==="number"&&isNaN(b))return c.message||"This field is required!";return p};m.view=function(b){function c(h){var a=(g[h.typeName]||e)({metadata:h,
engine:i}),f,j;l[a.id]=a;if(h.children&&h.children.length){f=0;for(j=h.children.length;f<j;f+=1)a.children.push(c(h.children[f]))}return a}var d={},i=b.engine,g=b.elementTypes,e=b.defaultElementType||m.element,l={};d.element=c(b.metadata);d.initialize=function(){d.element.initialize()};d.getElementById=function(h){return l[h]};return d};m.element=function(b){var c={},d=b.engine;b=b.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly"};c.id=b.id||t();c.properties=b.properties||
{};c.children=[];c.initialize=function(){};c.receiveMessage=function(g){var e=i[g.signal];e&&typeof c[e]==="function"&&c[e](g.data)};c.notifyValueChange=function(g){var e=c.properties.binding;if(typeof e==="string")d.sendMessage({senderId:c.id,path:e,signal:"value",data:g});else throw Error(s.elementWithoutBinding);};c.eachChild=function(g){var e,l;e=0;for(l=c.children.length;e<l;e+=1)g(c.children[e],e)};d.addReceiver(c.id,c);return c};m.metadataProvider=function(b){function c(a,f){var j,k,n,o,q;
f=f||g;f.id=a.id||t();f.typeName=a.typeName;f.properties=a.properties||{};if(a.children&&a.children.length){f.children=[];j=0;for(k=a.children.length;j<k;j+=1){n={};c(a.children[j],n);f.children.push(n)}}if(typeof a.binding==="string"){e.push({receiverId:f.id,path:a.binding,signal:"value"});f.properties.binding=a.binding}j=0;for(k=h.length;j<k;j+=1){n=h[j];o=a[n];if(typeof o==="string"){o=o;q={args:[]};var D=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,v=o;r=void 0;for(var z=void 0;(r=
D.exec(o))!==null;)q.args.push(r[0]);r=0;for(z=q.args.length;r<z;r+=1)v=v.replace(q.args[r],"arguments["+r+"]");q.processor=new Function("return "+v+";");o=q;q=t();l.push({id:q,processorArgs:o.args,processor:o.processor,signal:n});e.push({receiverId:q,path:o.args,signal:"value"});e.push({receiverId:f.id,senderId:q,signal:n})}}}var d={},i=[],g={},e=[],l=[],h=["hidden","readonly"];d.getModelMetadata=function(){return i};d.getViewMetadata=function(){return g};d.getRules=function(){return e};d.getTriggers=
function(){return l};c(b.metadata);return d};A.fe=m})(function(){return this}());
