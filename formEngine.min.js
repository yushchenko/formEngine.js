(function(D,o){function v(){z+=1;return"i"+z}function x(b,c){var e,g,h,f;e=c.split(".");f=b;g=0;for(h=e.length;g<h;g+=1){f=f[e[g]];if(f===o)return o}return f}function A(b,c,e){c=c.split(".");var g=c.length-1,h=b;for(b=0;b<g;b+=1){h=h[c[b]];if(h===o)return}h[c[g]]=e}function B(b,c){var e,g=b.length,h,f;for(e=0;e<g;e+=1)if(typeof b[e].length==="number"){h=0;for(f=b[e].length;h<f;h+=1)c(b[e][h])}else c(b[e])}function w(b,c){var e;b=b||"";for(e in c)if(c.hasOwnProperty(e))b=b.replace(RegExp("{"+e+"}",
"g"),c[e]);return b}var l={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,t={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.rule=function(b){function c(a,d,i){if(a)e[d]=function(j){var k,p;if(typeof a==="string")return i?a.indexOf(j)===0:a===j;if(typeof a==="object"&&a.length){k=0;for(p=a.length;k<p;k+=1)if(i?a[k].indexOf(j)===0:a[k]===j)return true;return false}return true}}var e={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],f=[false,true,false],m,n;e.receiverId=b.receiverId;e.path=b.path;m=0;for(n=g.length;m<n;m+=1)c(b[g[m]],
h[m],f[m]);e.transformData=function(a,d){var i;if(a!==o&&typeof d==="string"&&typeof b.path==="string"&&b.path.length>d.length){i=d.length;return x(a,b.path.slice(i>0?i+1:i))}return a};return e};l.trigger=function(b){var c={},e=b.id,g=b.engine,h=b.processor,f=b.processorArgs,m=b.signal;c.receiveMessage=function(){var n=[],a,d=f.length;for(a=0;a<d;a+=1)n.push(g.get(f[a]));n=h.apply(o,n);g.sendMessage({senderId:e,signal:m,data:n})};g.addReceiver(e,c);return c};l.engine=function(){function b(a,d){if(typeof a!==
"string")throw Error(t.receiverIdMustBeString);if(!d||typeof d!=="function"&&typeof d.receiveMessage!=="function")throw Error(t.noReceiveMessageMethod);if(a in h)throw Error(t.notUniqueReceiverId);h[a]=typeof d!=="function"?d:{receiveMessage:d}}function c(a){if(typeof a.receiverId!=="string")throw Error(t.noReceiverId);f.push(l.rule(a))}function e(a){a.engine=g;m.push(l.trigger(a))}var g={},h={},f=[],m=[],n=[];g.addReceiver=b;g.addRule=c;g.addRules=function(){B(arguments,c)};g.addTrigger=e;g.addTriggers=
function(){B(arguments,e)};g.addModel=function(a){n.push(a)};g.sendMessage=function(a){var d,i=f.length,j;for(d=0;d<i;d+=1){j=f[d];if(a.senderId!==j.receiverId)if((!j.checkSender||j.checkSender(a.senderId))&&(!j.checkPath||j.checkPath(a.path))&&(!j.checkSignal||j.checkSignal(a.signal))){if(!(j.receiverId in h))throw Error(t.receiverNotFound);h[j.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:j.path,signal:a.signal,data:j.transformData(a.data,a.path)})}}};g.get=function(a){var d,
i,j;d=0;for(i=n.length;d<i;d+=1){j=n[d].get(a);if(j!==o)return j}return o};g.subscribe=function(a,d){var i=v();b(i,d);a.receiverId=i;c(a)};return g};l.model=function(b){function c(a,d){var i,j,k,p,r,q={},u=true;if(typeof a!=="string")a="";i=0;for(j=n.length;i<j;i+=1){k=n[i];if(!(a&&k.path.indexOf(a)!==0)){q.hasOwnProperty(k.path)||(q[k.path]=[]);p=l.validators[k.validatorName];p=p(x(m,k.path),k.validatorProperties||{});if(p!==o){q[k.path].push(p);u=false}}}if(!d)for(r in q)q.hasOwnProperty(r)&&f.sendMessage({senderId:h,
path:r,signal:"error",data:q[r]});return u}function e(a,d){f.sendMessage({senderId:h,path:a,signal:"value",data:d})}b=b||{};var g={},h=b.id||v(),f=b.engine,m={},n=(b.metadata||{}).validationRules||[];g.receiveMessage=function(a){if(a.signal==="value"&&typeof a.path==="string"){A(m,a.path,a.data);c(a.path)}};g.set=function(){if(arguments.length===1){m=arguments[0];e("",m)}else{var a=arguments[0],d=arguments[1];A(m,a,d);e(a,d)}};g.get=function(a){if(a===o)return m;return x(m,a)};g.validate=c;if(f){f.addReceiver(h,
g);f.addRule({receiverId:h,signal:"value"});f.addModel(g)}return g};l.validators={};l.validators.required=function(b,c){if(b===o||b===null||typeof b==="string"&&(b===null||b===o?"":b.toString().replace(E,"").replace(F,""))===""||typeof b==="number"&&isNaN(b))return w(c.message||l.validationMessages.required,c);return o};l.validators.minLength=function(b,c){if(b&&b.length!==o&&b.length<c.length)return w(c.message||l.validationMessages.minLenght,c);return o};l.validators.minLength.defaultProperty="length";
l.validators.maxLength=function(b,c){if(b&&b.length!==o&&b.length>c.length)return w(c.message||l.validationMessages.maxLenght,c);return o};l.validators.maxLength.defaultProperty="length";l.validators.minValue=function(b,c){if(b&&b<c.value)return w(c.message||l.validationMessages.minValue,c);return o};l.validators.minValue.defaultProperty="value";l.validators.maxValue=function(b,c){if(b&&b>c.value)return w(c.message||l.validationMessages.maxValue,c);return o};l.validators.maxValue.defaultProperty=
"value";l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};l.view=function(b){function c(n){var a=(h[n.typeName]||f)({metadata:n,engine:g}),d,i;m[a.id]=a;if(n.children&&n.children.length){d=0;for(i=n.children.length;d<i;d+=1)a.children.push(c(n.children[d]))}return a}
var e={},g=b.engine,h=b.elementTypes,f=b.defaultElementType||l.element,m={};e.element=c(b.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(n){return m[n]};return e};l.element=function(b){var c={},e=b.engine;b=b.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=b.id||v();c.properties=b.properties||{};c.children=[];c.initialize=function(){};c.receiveMessage=function(h){var f=g[h.signal];f&&typeof c[f]==="function"&&
c[f](h.data)};c.notifyValueChange=function(h){var f=c.properties.binding;if(typeof f==="string")e.sendMessage({senderId:c.id,path:f,signal:"value",data:h});else throw Error(t.elementWithoutBinding);};c.eachChild=function(h){var f,m;f=0;for(m=c.children.length;f<m;f+=1)h(c.children[f],f)};e.addReceiver(c.id,c);return c};l.metadataProvider=function(b){function c(a,d){var i,j,k;d=d||h;d.id=a.id||v();d.typeName=a.typeName;d.properties=a.properties||{};if(a.children&&a.children.length){d.children=[];i=
0;for(j=a.children.length;i<j;i+=1){k={};c(a.children[i],k);d.children.push(k)}}if(typeof a.binding==="string"){d.properties.binding=a.binding;i=a.validationRules||{};j=a.binding;var p,r;for(p in i)if(i.hasOwnProperty(p)){k=l.validators[p];if(k===o)throw Error(t.unknownValidator+p);if(typeof i[p]==="object")r=i[p];else if(typeof k.defaultProperty==="string"){r={};r[k.defaultProperty]=i[p]}g.validationRules.push({path:j,validatorName:p,validatorProperties:r})}f.push({receiverId:d.id,path:a.binding,
signal:["value","error"]})}p=d;var q;r=0;for(i=n.length;r<i;r+=1){j=n[r];k=a[j];if(typeof k==="string"){k=k;q={args:[]};var u=[],G=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,s=void 0,y=k;s=void 0;for(var C=void 0;(s=G.exec(k))!==null;){u.push(s[0]);q.args.push(s[1])}s=0;for(C=u.length;s<C;s+=1)y=y.replace(u[s],"arguments["+s+"]");q.processor=new Function("return "+y+";");k=q;q=v();m.push({id:q,processorArgs:k.args,processor:k.processor,signal:j});f.push({receiverId:q,path:k.args,signal:"value"});
f.push({receiverId:p.id,senderId:q,signal:j})}}}var e={},g={validationRules:[]},h={},f=[],m=[],n=["value","hidden","readonly"];e.getModelMetadata=function(){return g};e.getViewMetadata=function(){return h};e.getRules=function(){return f};e.getTriggers=function(){return m};c(b.metadata);return e};D.fe=l})(function(){return this}());
