(function(C,p){function u(){y+=1;return"i"+y}function w(b,c){var e,g,h,f;e=c.split(".");f=b;g=0;for(h=e.length;g<h;g+=1){f=f[e[g]];if(f===p)return p}return f}function z(b,c,e){c=c.split(".");var g=c.length-1,h=b;for(b=0;b<g;b+=1){h=h[c[b]];if(h===p)return}h[c[g]]=e}function A(b,c){var e,g=b.length,h,f;for(e=0;e<g;e+=1)if(typeof b[e].length==="number"){h=0;for(f=b[e].length;h<f;h+=1)c(b[e][h])}else c(b[e])}function v(b,c){var e;b=b||"";for(e in c)if(c.hasOwnProperty(e))b=b.replace(RegExp("{"+e+"}",
"g"),c[e]);return b}var l={version:"0.0.1"},y=0,D=/^\s+/,E=/\s+$/,t={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.rule=function(b){function c(a,d,i){if(a)e[d]=function(k){var j,o;if(typeof a==="string")return i?a.indexOf(k)===0:a===k;if(typeof a==="object"&&a.length){j=0;for(o=a.length;j<o;j+=1)if(i?a[j].indexOf(k)===0:a[j]===k)return true;return false}return true}}var e={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],f=[false,true,false],m,n;e.receiverId=b.receiverId;e.path=b.path;m=0;for(n=g.length;m<n;m+=1)c(b[g[m]],
h[m],f[m]);e.transformData=function(a,d){var i;if(a!==p&&typeof d==="string"&&typeof b.path==="string"&&b.path.length>d.length){i=d.length;return w(a,b.path.slice(i>0?i+1:i))}return a};return e};l.trigger=function(b){var c={},e=b.id,g=b.engine,h=b.processor,f=b.processorArgs,m=b.signal;c.receiveMessage=function(){var n=[],a,d=f.length;for(a=0;a<d;a+=1)n.push(g.get(f[a]));n=h.apply(p,n);g.sendMessage({senderId:e,signal:m,data:n})};g.addReceiver(e,c);return c};l.engine=function(){function b(a,d){if(typeof a!==
"string")throw Error(t.receiverIdMustBeString);if(!d||typeof d!=="function"&&typeof d.receiveMessage!=="function")throw Error(t.noReceiveMessageMethod);if(a in h)throw Error(t.notUniqueReceiverId);h[a]=typeof d!=="function"?d:{receiveMessage:d}}function c(a){if(typeof a.receiverId!=="string")throw Error(t.noReceiverId);f.push(l.rule(a))}function e(a){a.engine=g;m.push(l.trigger(a))}var g={},h={},f=[],m=[],n=[];g.addReceiver=b;g.addRule=c;g.addRules=function(){A(arguments,c)};g.addTrigger=e;g.addTriggers=
function(){A(arguments,e)};g.addModel=function(a){n.push(a)};g.sendMessage=function(a){var d,i=f.length,k;for(d=0;d<i;d+=1){k=f[d];if(a.senderId!==k.receiverId)if((!k.checkSender||k.checkSender(a.senderId))&&(!k.checkPath||k.checkPath(a.path))&&(!k.checkSignal||k.checkSignal(a.signal))){if(!(k.receiverId in h))throw Error(t.receiverNotFound);h[k.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:k.path,signal:a.signal,data:k.transformData(a.data,a.path)})}}};g.get=function(a){var d,
i,k;d=0;for(i=n.length;d<i;d+=1){k=n[d].get(a);if(k!==p)return k}return p};g.subscribe=function(a,d){var i=u();b(i,d);a.receiverId=i;c(a)};return g};l.model=function(b){function c(a,d){var i,k,j,o,q,s={},r=true;if(typeof a!=="string")a="";i=0;for(k=n.length;i<k;i+=1){j=n[i];if(!(a&&j.path.indexOf(a)!==0)){s.hasOwnProperty(j.path)||(s[j.path]=[]);o=l.validators[j.validatorName];o=o(w(m,j.path),j.validatorProperties||{});if(o!==p){s[j.path].push(o);r=false}}}if(!d)for(q in s)s.hasOwnProperty(q)&&f.sendMessage({senderId:h,
path:q,signal:"error",data:s[q]});return r}function e(a,d){f.sendMessage({senderId:h,path:a,signal:"value",data:d})}b=b||{};var g={},h=b.id||u(),f=b.engine,m={},n=(b.metadata||{}).validationRules||[];g.receiveMessage=function(a){if(a.signal==="value"&&typeof a.path==="string"){z(m,a.path,a.data);c(a.path)}};g.set=function(){if(arguments.length===1){m=arguments[0];e("",m)}else{var a=arguments[0],d=arguments[1];z(m,a,d);e(a,d)}};g.get=function(a){if(a===p)return m;return w(m,a)};g.validate=c;if(f){f.addReceiver(h,
g);f.addRule({receiverId:h,signal:"value"});f.addModel(g)}return g};l.validators={};l.validators.required=function(b,c){if(b===p||b===null||typeof b==="string"&&(b===null||b===p?"":b.toString().replace(D,"").replace(E,""))===""||typeof b==="number"&&isNaN(b))return v(c.message||l.validationMessages.required,c);return p};l.validators.minLength=function(b,c){if(b&&b.length!==p&&b.length<c.length)return v(c.message||l.validationMessages.minLenght,c);return p};l.validators.minLength.defaultProperty="length";
l.validators.maxLength=function(b,c){if(b&&b.length!==p&&b.length>c.length)return v(c.message||l.validationMessages.maxLenght,c);return p};l.validators.maxLength.defaultProperty="length";l.validators.minValue=function(b,c){if(b&&b<c.value)return v(c.message||l.validationMessages.minValue,c);return p};l.validators.minValue.defaultProperty="value";l.validators.maxValue=function(b,c){if(b&&b>c.value)return v(c.message||l.validationMessages.maxValue,c);return p};l.validators.maxValue.defaultProperty=
"value";l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};l.view=function(b){function c(n){var a=(h[n.typeName]||f)({metadata:n,engine:g}),d,i;m[a.id]=a;if(n.children&&n.children.length){d=0;for(i=n.children.length;d<i;d+=1)a.children.push(c(n.children[d]))}return a}
var e={},g=b.engine,h=b.elementTypes,f=b.defaultElementType||l.element,m={};e.element=c(b.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(n){return m[n]};return e};l.element=function(b){var c={},e=b.engine;b=b.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=b.id||u();c.properties=b.properties||{};c.children=[];c.initialize=function(){};c.receiveMessage=function(h){var f=g[h.signal];f&&typeof c[f]==="function"&&
c[f](h.data)};c.notifyValueChange=function(h){var f=c.properties.binding;if(typeof f==="string")e.sendMessage({senderId:c.id,path:f,signal:"value",data:h});else throw Error(t.elementWithoutBinding);};c.eachChild=function(h){var f,m;f=0;for(m=c.children.length;f<m;f+=1)h(c.children[f],f)};e.addReceiver(c.id,c);return c};l.metadataProvider=function(b){function c(a,d){var i,k,j,o,q;d=d||h;d.id=a.id||u();d.typeName=a.typeName;d.properties=a.properties||{};if(a.children&&a.children.length){d.children=
[];i=0;for(k=a.children.length;i<k;i+=1){j={};c(a.children[i],j);d.children.push(j)}}if(typeof a.binding==="string"){d.properties.binding=a.binding;i=a.validationRules||{};k=a.binding;for(o in i)if(i.hasOwnProperty(o)){j=l.validators[o];if(j===p)throw Error(t.unknownValidator+o);if(typeof i[o]==="object")q=i[o];else if(typeof j.defaultProperty==="string"){q={};q[j.defaultProperty]=i[o]}g.validationRules.push({path:k,validatorName:o,validatorProperties:q})}f.push({receiverId:d.id,path:a.binding,signal:["value",
"error"]})}i=0;for(k=n.length;i<k;i+=1){o=n[i];q=a[o];if(typeof q==="string"){q=q;j={args:[]};var s=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,x=q;r=void 0;for(var B=void 0;(r=s.exec(q))!==null;)j.args.push(r[0]);r=0;for(B=j.args.length;r<B;r+=1)x=x.replace(j.args[r],"arguments["+r+"]");j.processor=new Function("return "+x+";");q=j;j=u();m.push({id:j,processorArgs:q.args,processor:q.processor,signal:o});f.push({receiverId:j,path:q.args,signal:"value"});f.push({receiverId:d.id,senderId:j,
signal:o})}}}var e={},g={validationRules:[]},h={},f=[],m=[],n=["hidden","readonly"];e.getModelMetadata=function(){return g};e.getViewMetadata=function(){return h};e.getRules=function(){return f};e.getTriggers=function(){return m};c(b.metadata);return e};C.fe=l})(function(){return this}());
