(function(B,q){function u(){x+=1;return"i"+x}function v(b,c){var f,g,h,e;f=c.split(".");e=b;g=0;for(h=f.length;g<h;g+=1){e=e[f[g]];if(e===q)return q}return e}function y(b,c,f){c=c.split(".");var g=c.length-1,h=b;for(b=0;b<g;b+=1){h=h[c[b]];if(h===q)return}h[c[g]]=f}function z(b,c){var f,g=b.length,h,e;for(f=0;f<g;f+=1)if(typeof b[f].length==="number"){h=0;for(e=b[f].length;h<e;h+=1)c(b[f][h])}else c(b[f])}var o={version:"0.0.1"},x=0,C=/^\s+/,D=/\s+$/,t={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",
receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",unknownValidator:"metadataProvider: unknown validator: "};o.rule=function(b){function c(a,
d,i){if(a)f[d]=function(k){var j,n;if(typeof a==="string")return i?a.indexOf(k)===0:a===k;if(typeof a==="object"&&a.length){j=0;for(n=a.length;j<n;j+=1)if(i?a[j].indexOf(k)===0:a[j]===k)return true;return false}return true}}var f={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],e=[false,true,false],l,m;f.receiverId=b.receiverId;f.path=b.path;l=0;for(m=g.length;l<m;l+=1)c(b[g[l]],h[l],e[l]);f.transformData=function(a,d){var i;if(a!==q&&typeof d==="string"&&typeof b.path===
"string"&&b.path.length>d.length){i=d.length;return v(a,b.path.slice(i>0?i+1:i))}return a};return f};o.trigger=function(b){var c={},f=b.id,g=b.engine,h=b.processor,e=b.processorArgs,l=b.signal;c.receiveMessage=function(){var m=[],a,d=e.length;for(a=0;a<d;a+=1)m.push(g.get(e[a]));m=h.apply(q,m);g.sendMessage({senderId:f,signal:l,data:m})};g.addReceiver(f,c);return c};o.engine=function(){function b(a,d){if(typeof a!=="string")throw Error(t.receiverIdMustBeString);if(!d||typeof d!=="function"&&typeof d.receiveMessage!==
"function")throw Error(t.noReceiveMessageMethod);if(a in h)throw Error(t.notUniqueReceiverId);h[a]=typeof d!=="function"?d:{receiveMessage:d}}function c(a){if(typeof a.receiverId!=="string")throw Error(t.noReceiverId);e.push(o.rule(a))}function f(a){a.engine=g;l.push(o.trigger(a))}var g={},h={},e=[],l=[],m=[];g.addReceiver=b;g.addRule=c;g.addRules=function(){z(arguments,c)};g.addTrigger=f;g.addTriggers=function(){z(arguments,f)};g.addModel=function(a){m.push(a)};g.sendMessage=function(a){var d,i=
e.length,k;for(d=0;d<i;d+=1){k=e[d];if(a.senderId!==k.receiverId)if((!k.checkSender||k.checkSender(a.senderId))&&(!k.checkPath||k.checkPath(a.path))&&(!k.checkSignal||k.checkSignal(a.signal))){if(!(k.receiverId in h))throw Error(t.receiverNotFound);h[k.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:k.path,signal:a.signal,data:k.transformData(a.data,a.path)})}}};g.get=function(a){var d,i,k;d=0;for(i=m.length;d<i;d+=1){k=m[d].get(a);if(k!==q)return k}return q};g.subscribe=function(a,
d){var i=u();b(i,d);a.receiverId=i;c(a)};return g};o.model=function(b){function c(a,d){var i,k,j,n,p,s={},r=true;if(typeof a!=="string")a="";i=0;for(k=m.length;i<k;i+=1){j=m[i];if(!(a&&j.path.indexOf(a)!==0)){s.hasOwnProperty(j.path)||(s[j.path]=[]);n=o.validators[j.validatorName];n=n(v(l,j.path),j.validatorProperties||{});if(n!==q){s[j.path].push(n);r=false}}}if(!d)for(p in s)s.hasOwnProperty(p)&&e.sendMessage({senderId:h,path:p,signal:"error",data:s[p]});return r}function f(a,d){e.sendMessage({senderId:h,
path:a,signal:"value",data:d})}b=b||{};var g={},h=b.id||u(),e=b.engine,l={},m=(b.metadata||{}).validationRules||[];g.receiveMessage=function(a){if(a.signal==="value"&&typeof a.path==="string"){y(l,a.path,a.data);c(a.path)}};g.set=function(){if(arguments.length===1){l=arguments[0];f("",l)}else{var a=arguments[0],d=arguments[1];y(l,a,d);f(a,d)}};g.get=function(a){if(a===q)return l;return v(l,a)};g.validate=c;if(e){e.addReceiver(h,g);e.addRule({receiverId:h,signal:"value"});e.addModel(g)}return g};o.validators=
{};o.validators.required=function(b,c){if(b===q||b===null||typeof b==="string"&&(b===null||b===q?"":b.toString().replace(C,"").replace(D,""))===""||typeof b==="number"&&isNaN(b))return c.message||"This field is required!";return q};o.validators.minLength=function(b,c){if(b.length!==q&&b.length<c.length)return c.message||"This field is too short!";return q};o.validators.minLength.defaultProperty="length";o.validators.maxLength=function(b,c){if(b.length!==q&&b.length>c.length)return c.message||"This field is too long!";
return q};o.validators.maxLength.defaultProperty="length";o.view=function(b){function c(m){var a=(h[m.typeName]||e)({metadata:m,engine:g}),d,i;l[a.id]=a;if(m.children&&m.children.length){d=0;for(i=m.children.length;d<i;d+=1)a.children.push(c(m.children[d]))}return a}var f={},g=b.engine,h=b.elementTypes,e=b.defaultElementType||o.element,l={};f.element=c(b.metadata);f.initialize=function(){f.element.initialize()};f.getElementById=function(m){return l[m]};return f};o.element=function(b){var c={},f=b.engine;
b=b.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=b.id||u();c.properties=b.properties||{};c.children=[];c.initialize=function(){};c.receiveMessage=function(h){var e=g[h.signal];e&&typeof c[e]==="function"&&c[e](h.data)};c.notifyValueChange=function(h){var e=c.properties.binding;if(typeof e==="string")f.sendMessage({senderId:c.id,path:e,signal:"value",data:h});else throw Error(t.elementWithoutBinding);};c.eachChild=function(h){var e,l;e=0;for(l=
c.children.length;e<l;e+=1)h(c.children[e],e)};f.addReceiver(c.id,c);return c};o.metadataProvider=function(b){function c(a,d){var i,k,j,n,p;d=d||h;d.id=a.id||u();d.typeName=a.typeName;d.properties=a.properties||{};if(a.children&&a.children.length){d.children=[];i=0;for(k=a.children.length;i<k;i+=1){j={};c(a.children[i],j);d.children.push(j)}}if(typeof a.binding==="string"){d.properties.binding=a.binding;i=a.validationRules||{};k=a.binding;for(n in i)if(i.hasOwnProperty(n)){j=o.validators[n];if(j===
q)throw Error(t.unknownValidator+n);if(typeof i[n]==="object")p=i[n];else if(typeof j.defaultProperty==="string"){p={};p[j.defaultProperty]=i[n]}g.validationRules.push({path:k,validatorName:n,validatorProperties:p})}e.push({receiverId:d.id,path:a.binding,signal:["value","error"]})}i=0;for(k=m.length;i<k;i+=1){n=m[i];p=a[n];if(typeof p==="string"){p=p;j={args:[]};var s=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,w=p;r=void 0;for(var A=void 0;(r=s.exec(p))!==null;)j.args.push(r[0]);r=0;
for(A=j.args.length;r<A;r+=1)w=w.replace(j.args[r],"arguments["+r+"]");j.processor=new Function("return "+w+";");p=j;j=u();l.push({id:j,processorArgs:p.args,processor:p.processor,signal:n});e.push({receiverId:j,path:p.args,signal:"value"});e.push({receiverId:d.id,senderId:j,signal:n})}}}var f={},g={validationRules:[]},h={},e=[],l=[],m=["hidden","readonly"];f.getModelMetadata=function(){return g};f.getViewMetadata=function(){return h};f.getRules=function(){return e};f.getTriggers=function(){return l};
c(b.metadata);return f};B.fe=o})(function(){return this}());
