(function(F,o){function w(){B+=1;return"i"+B}function A(a,b){var e,c,f,i;e=b.split(".");i=a;c=0;for(f=e.length;c<f;c+=1){i=i[e[c]];if(i===o||i===null)return o}return i}function C(a,b,e){b=b.split(".");var c=b.length-1,f=a;for(a=0;a<c;a+=1){f=f[b[a]];if(f===o)return}f[b[c]]=e}function D(a,b){var e,c=a.length,f,i;for(e=0;e<c;e+=1)if(typeof a[e].length==="number"){f=0;for(i=a[e].length;f<i;f+=1)b(a[e][f])}else b(a[e])}function z(a,b){var e;a=a||"";for(e in b)if(b.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),b[e]);return a}var l={version:"0.0.1"},B=0,G=/^\s+/,H=/\s+$/,x={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.dsl={};l.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,b){this.element.properties[a]=b;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};l.dsl.elementConstructor=function(a,b,e){function c(f,i,j){function g(h,m){f[h]=function(){return m.apply(j,arguments)}}for(var d in i)i.hasOwnProperty(d)&&g(d,i[d])}b=b||{};b.defaultProperty=b.defaultProperty||"binding";e=e||{};return function(){function f(){var g,d=arguments.length,h;for(g=0;g<d;g+=1){h=arguments[g];if(typeof h==="function"&&typeof h.get===
"function")i.elements.push(h.get());else if(g===0&&typeof b.defaultProperty==="string")i[b.defaultProperty]=h}return f}var i={typeName:a,properties:{},validationRules:{},elements:[]},j={element:i,chain:f,params:b};typeof b.initialize==="function"&&b.initialize.apply(j);c(f,l.dsl.defaultElementProperties,j);c(f,e,j);return f.apply(o,arguments)}};l.rule=function(a){function b(d,h,m){if(d)e[h]=function(n){var q,k;if(typeof d==="string")return m?d.indexOf(n)===0:d===n;if(typeof d==="object"&&d.length){q=
0;for(k=d.length;q<k;q+=1)if(m?d[q].indexOf(n)===0:d[q]===n)return true;return false}return true}}var e={},c=["senderId","path","signal"],f=["checkSender","checkPath","checkSignal"],i=[false,true,false],j,g;e.receiverId=a.receiverId;e.path=a.path;j=0;for(g=c.length;j<g;j+=1)b(a[c[j]],f[j],i[j]);e.transformData=function(d,h){var m;if(d!==o&&typeof h==="string"&&typeof a.path==="string"&&a.path.length>h.length){m=h.length;return A(d,a.path.slice(m>0?m+1:m))}return d};return e};l.triggers={};l.triggers.expression=
function(a){var b={},e=a.id,c=a.engine,f=a.processor,i=a.processorArgs,j=a.signal;b.receiveMessage=function(){var g=[],d,h=i.length;for(d=0;d<h;d+=1)g.push(c.get(i[d]));g=f.apply(o,g);c.sendMessage({senderId:e,signal:j,data:g})};c.addReceiver(e,b);return b};l.triggers.change=function(a){var b={},e=a.id,c=a.engine,f={};b.receiveMessage=function(i){var j,g={"default":0,changed:0,saved:0},d=0;f[i.path]=i.data;for(j in f)if(f.hasOwnProperty(j)){g[f[j]]+=1;d+=1}c.sendMessage({senderId:e,signal:"change",
data:d===g["default"]?"default":g.changed===0?"saved":"changed"})};c.addReceiver(e,b);return b};l.engine=function(){function a(d,h){if(typeof d!=="string")throw Error(x.receiverIdMustBeString);if(!h||typeof h!=="function"&&typeof h.receiveMessage!=="function")throw Error(x.noReceiveMessageMethod);if(d in f)throw Error(x.notUniqueReceiverId);f[d]=typeof h!=="function"?h:{receiveMessage:h}}function b(d){if(typeof d.receiverId!=="string")throw Error(x.noReceiverId);i.push(l.rule(d))}function e(d){d.engine=
c;j.push(l.triggers[d.type](d))}var c={},f={},i=[],j=[],g=[];c.addReceiver=a;c.addRule=b;c.addRules=function(){D(arguments,b)};c.addTrigger=e;c.addTriggers=function(){D(arguments,e)};c.addModel=function(d){g.push(d)};c.sendMessage=function(d){var h,m=i.length,n;for(h=0;h<m;h+=1){n=i[h];if(d.senderId!==n.receiverId)if((!n.checkSender||n.checkSender(d.senderId))&&(!n.checkPath||n.checkPath(d.path))&&(!n.checkSignal||n.checkSignal(d.signal))){if(!(n.receiverId in f))throw Error(x.receiverNotFound);f[n.receiverId].receiveMessage({senderId:d.senderId,
path:d.path,rulePath:n.path,signal:d.signal,data:n.transformData(d.data,d.path)})}}};c.get=function(d){var h,m,n;h=0;for(m=g.length;h<m;h+=1){n=g[h].get(d);if(n!==o)return n}return o};c.subscribe=function(d,h){var m=w();a(m,h);d.receiverId=m;b(d)};return c};l.validationRule=function(a){var b={},e=a.id||w(),c=a.engine,f=a.path,i=l.validators[a.validatorName],j=a.validatorProperties||{},g;b.receiveMessage=function(d){if(d.signal==="validation-inactive")g=d.data};b.validate=function(d){if(g)return o;
d=A(d,f);return i(d,j)};b.path=f;c.addReceiver(e,b);return b};l.model=function(a){function b(){if(arguments.length===1){m=arguments[0];i("",m)}else{var k=arguments[0],p=arguments[1];C(m,k,p);i(k,p)}}function e(k){if(k===o)return m;return A(m,k)}function c(k,p){var s,r,t,u,v,y={},E=true;if(typeof k!=="string")k="";s=0;for(r=n.length;s<r;s+=1){t=n[s];if(!(k&&t.path.indexOf(k)!==0)){y.hasOwnProperty(t.path)||(y[t.path]=[]);u=t.validate(m);if(u!==o){y[t.path].push(u);E=false}}}if(!p)for(v in y)y.hasOwnProperty(v)&&
h.sendMessage({senderId:d,path:v,signal:"error",data:y[v]});return E}function f(k){if(q){var p=q[{back:"moveBack",forward:"moveForward"}[k]](),s;if(p){s=p.path;b(s,p[{back:"oldValue",forward:"newValue"}[k]]);j(s);c(s)}}}function i(k,p){h.sendMessage({senderId:d,path:k,signal:"value",data:p})}function j(k,p){h.sendMessage({senderId:d,path:k,signal:"change",data:p||q.getStatus(k)})}a=a||{};var g={},d=a.id||w(),h=a.engine,m={},n=[],q=a.trackChanges?l.changeTracker():o;g.receiveMessage=function(k){if(k.signal===
"value"&&typeof k.path==="string"){if(q){q.push({path:k.path,oldValue:e(k.path),newValue:k.data});j(k.path)}C(m,k.path,k.data);c(k.path)}};g.set=b;g.get=e;g.validate=c;g.undo=function(){f("back")};g.redo=function(){f("forward")};g.getUndoCount=function(){if(!q)return o;return q.getBackCount()};g.getRedoCount=function(){if(!q)return o;return q.getForwardCount()};g.markSave=function(){if(q){var k,p=q.markSave();for(k=0;k<p.length;k+=1)j(p[k],"saved")}};(function(){var k=(a.metadata||{}).validationRules||
[],p,s=k.length,r;for(p=0;p<s;p+=1){r=k[p];n.push(l.validationRule({id:r.id,engine:h,path:r.path,validatorName:r.validatorName,validatorProperties:r.validatorProperties}))}})();h.addReceiver(d,g);h.addRule({receiverId:d,signal:"value"});h.addModel(g);return g};l.validators={};l.validators.required=function(a,b){if(a===o||a===null||typeof a==="string"&&(a===null||a===o?"":a.toString().replace(G,"").replace(H,""))===""||typeof a==="number"&&isNaN(a))return z(b.message||l.validationMessages.required,
b);return o};l.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};l.validators.minLength=function(a,b){if(a&&a.length!==o&&a.length<b.length)return z(b.message||l.validationMessages.minLenght,b);return o};l.validators.minLength.defaultProperty="length";l.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};l.validators.maxLength=function(a,b){if(a&&a.length!==o&&a.length>b.length)return z(b.message||
l.validationMessages.maxLenght,b);return o};l.validators.maxLength.defaultProperty="length";l.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};l.validators.minValue=function(a,b){if(a&&a<b.value)return z(b.message||l.validationMessages.minValue,b);return o};l.validators.minValue.defaultProperty="value";l.dsl.defaultElementProperties.minValue=function(a){this.element.validationRules.minValue=a;return this.chain};l.validators.maxValue=function(a,
b){if(a&&a>b.value)return z(b.message||l.validationMessages.maxValue,b);return o};l.validators.maxValue.defaultProperty="value";l.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};
l.changeTracker=function(){var a={},b=[],e=-1,c=-1;a.push=function(f){e<b.length-1&&b.splice(e+1);b.push(f);e+=1};a.moveBack=function(){if(e>=0){e-=1;return b[e+1]}return o};a.moveForward=function(){var f=b[e+1];if(f){e+=1;return f}return o};a.getBackCount=function(){return e+1};a.getForwardCount=function(){return b.length-e-1};a.getStatus=function(f){var i;for(i=e;i>=0;i-=1)if(b[i].path===f)return i<=c?"saved":"changed";return"default"};a.markSave=function(){var f,i=[];for(f=c+1;f<=e;f+=1)i.push(b[f].path);
c=e;return i};return a};l.view=function(a){function b(g){var d=(f[g.typeName]||i)({metadata:g,engine:c}),h,m;j[d.id]=d;if(g.elements&&g.elements.length){h=0;for(m=g.elements.length;h<m;h+=1)d.addElement(b(g.elements[h]))}return d}var e={},c=a.engine,f=a.elementTypes,i=a.defaultElementType||l.element,j={};e.element=b(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(g){return j[g]};return e};l.element=function(a){function b(){f.sendMessage({senderId:c.id,signal:"validation-inactive",
data:c.isHidden()||c.isReadonly()});e(function(j){j.notifyValidationStatusChange()})}function e(j){var g,d;g=0;for(d=c.elements.length;g<d;g+=1)j(c.elements[g],g)}var c={},f=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors",change:"setStatus"};c.id=a.id||w();c.properties=a.properties||{};c.elements=[];c.parent=o;c.initialize=function(){};c.addElement=function(j){c.elements.push(j);j.parent=c};c.receiveMessage=function(j){var g=i[j.signal];
g&&typeof c[g]==="function"&&c[g](j.data)};c.setValue=void 0;c.notifyValueChange=function(j){var g=c.properties.binding;if(typeof g==="string")f.sendMessage({senderId:c.id,path:g,signal:"value",data:j});else throw Error(x.elementWithoutBinding);};c.setHidden=function(j){c.hidden=j;b()};c.setReadonly=function(j){c.readonly=j;b()};c.isHidden=function(){return!!c.hidden||c.parent&&c.parent.isHidden()};c.isReadonly=function(){return!!c.readonly};c.notifyValidationStatusChange=b;c.showErrors=function(){};
c.eachChild=e;f.addReceiver(c.id,c);return c};l.expressionParser=function(a){for(var b={args:[]},e=[],c=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,f,i=a;(f=c.exec(a))!==null;){e.push(f[0]);b.args.push(f[1])}a=0;for(c=e.length;a<c;a+=1)i=i.replace(e[a],"arguments["+a+"]");b.processor=new Function("return "+i+";");return b};l.metadataProvider=function(a){function b(h,m){var n,q,k;m=m||f;m.id=h.id||w();m.typeName=h.typeName;m.properties=h.properties||{};k=m;var p,s,r,t,u,v;p=0;for(s=g.length;p<
s;p+=1){r=g[p];t=h[r];if(typeof t==="string"){t=d(t);u=w();v={id:u,type:"expression",processorArgs:t.args,processor:t.processor,signal:r};j.push(v);i.push({receiverId:u,path:t.args,signal:"value"});i.push({receiverId:k.id,senderId:u,signal:r});if(r==="value"){u=w();v={id:u,type:"change",processorArgs:t.args,signal:"change"};j.push(v);i.push({receiverId:u,path:t.args,signal:"change"});i.push({receiverId:k.id,senderId:u,signal:"change"})}}}if(typeof h.binding==="string"){m.properties.binding=h.binding;
k=m;p=h.binding;s=h.validationRules||{};for(n in s)if(s.hasOwnProperty(n)){r=l.validators[n];if(r===o)throw Error(x.unknownValidator+n);if(typeof s[n]==="object")q=s[n];else if(typeof r.defaultProperty==="string"){q={};q[r.defaultProperty]=s[n]}r=w();c.validationRules.push({id:r,path:p,validatorName:n,validatorProperties:q});i.push({receiverId:r,senderId:k.id,signal:"validation-inactive"})}i.push({receiverId:m.id,path:h.binding,signal:["value","error","change"]})}if(h.elements&&h.elements.length){m.elements=
[];n=0;for(q=h.elements.length;n<q;n+=1){k={};b(h.elements[n],k,m);m.elements.push(k)}}}var e={},c={validationRules:[]},f={},i=[],j=[],g=a.expressionProperties||["value","hidden","readonly"],d=a.expressionParser||l.expressionParser;e.getModelMetadata=function(){return c};e.getViewMetadata=function(){return f};e.getRules=function(){return i};e.getTriggers=function(){return j};b(a.metadata);return e};F.fe=l})(function(){return this}());
