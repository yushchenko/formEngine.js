(function(F,o){function w(){B+=1;return"i"+B}function A(a,c){var e,b,f,i;e=c.split(".");i=a;b=0;for(f=e.length;b<f;b+=1){i=i[e[b]];if(i===o||i===null)return o}return i}function C(a,c,e){c=c.split(".");var b=c.length-1,f=a;for(a=0;a<b;a+=1){f=f[c[a]];if(f===o)return}f[c[b]]=e}function D(a,c){var e,b=a.length,f,i;for(e=0;e<b;e+=1)if(typeof a[e].length==="number"){f=0;for(i=a[e].length;f<i;f+=1)c(a[e][f])}else c(a[e])}function z(a,c){var e;a=a||"";for(e in c)if(c.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),c[e]);return a}var l={version:"0.0.1"},B=0,G=/^\s+/,H=/\s+$/,x={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.dsl={};l.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,c){this.element.properties[a]=c;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};l.dsl.elementConstructor=function(a,c,e){function b(f,i,k){function g(h,m){f[h]=function(){return m.apply(k,arguments)}}for(var d in i)i.hasOwnProperty(d)&&g(d,i[d])}c=c||{};c.defaultProperty=c.defaultProperty||"binding";e=e||{};return function(){function f(){var g,d=arguments.length,h;for(g=0;g<d;g+=1){h=arguments[g];if(typeof h==="function"&&typeof h.get===
"function")i.elements.push(h.get());else if(g===0&&typeof c.defaultProperty==="string")i[c.defaultProperty]=h}return f}var i={typeName:a,properties:{},validationRules:{},elements:[]},k={element:i,chain:f,params:c};typeof c.initialize==="function"&&c.initialize.apply(k);b(f,l.dsl.defaultElementProperties,k);b(f,e,k);return f.apply(o,arguments)}};l.rule=function(a){function c(d,h,m){if(d)e[h]=function(n){var q,j;if(typeof d==="string")return m?d.indexOf(n)===0:d===n;if(typeof d==="object"&&d.length){q=
0;for(j=d.length;q<j;q+=1)if(m?d[q].indexOf(n)===0:d[q]===n)return true;return false}return true}}var e={},b=["senderId","path","signal"],f=["checkSender","checkPath","checkSignal"],i=[false,true,false],k,g;e.receiverId=a.receiverId;e.path=a.path;k=0;for(g=b.length;k<g;k+=1)c(a[b[k]],f[k],i[k]);e.transformData=function(d,h){var m;if(d!==o&&typeof h==="string"&&typeof a.path==="string"&&a.path.length>h.length){m=h.length;return A(d,a.path.slice(m>0?m+1:m))}return d};return e};l.triggers={};l.triggers.expression=
function(a){var c={},e=a.id,b=a.engine,f=a.processor,i=a.processorArgs,k=a.signal;c.receiveMessage=function(){var g=[],d,h=i.length;for(d=0;d<h;d+=1)g.push(b.get(i[d]));g=f.apply(o,g);b.sendMessage({senderId:e,signal:k,data:g})};b.addReceiver(e,c);return c};l.triggers.change=function(a){var c={},e=a.id,b=a.engine,f={};c.receiveMessage=function(i){var k,g={"default":0,changed:0,saved:0},d=0;f[i.path]=i.data;for(k in f)if(f.hasOwnProperty(k)){g[f[k]]+=1;d+=1}b.sendMessage({senderId:e,signal:"change",
data:d===g["default"]?"default":g.changed===0?"saved":"changed"})};b.addReceiver(e,c);return c};l.engine=function(){function a(d,h){if(typeof d!=="string")throw Error(x.receiverIdMustBeString);if(!h||typeof h!=="function"&&typeof h.receiveMessage!=="function")throw Error(x.noReceiveMessageMethod);if(d in f)throw Error(x.notUniqueReceiverId);f[d]=typeof h!=="function"?h:{receiveMessage:h}}function c(d){if(typeof d.receiverId!=="string")throw Error(x.noReceiverId);i.push(l.rule(d))}function e(d){d.engine=
b;k.push(l.triggers[d.type](d))}var b={},f={},i=[],k=[],g=[];b.addReceiver=a;b.addRule=c;b.addRules=function(){D(arguments,c)};b.addTrigger=e;b.addTriggers=function(){D(arguments,e)};b.addModel=function(d){g.push(d)};b.sendMessage=function(d){var h,m=i.length,n;for(h=0;h<m;h+=1){n=i[h];if(d.senderId!==n.receiverId)if((!n.checkSender||n.checkSender(d.senderId))&&(!n.checkPath||n.checkPath(d.path))&&(!n.checkSignal||n.checkSignal(d.signal))){if(!(n.receiverId in f))throw Error(x.receiverNotFound);f[n.receiverId].receiveMessage({senderId:d.senderId,
path:d.path,rulePath:n.path,signal:d.signal,data:n.transformData(d.data,d.path)})}}};b.get=function(d){var h,m,n;h=0;for(m=g.length;h<m;h+=1){n=g[h].get(d);if(n!==o)return n}return o};b.subscribe=function(d,h){var m=w();a(m,h);d.receiverId=m;c(d)};return b};l.validationRule=function(a){var c={},e=a.id||w(),b=a.engine,f=a.path,i=l.validators[a.validatorName],k=a.validatorProperties||{},g;c.receiveMessage=function(d){if(d.signal==="validation-inactive")g=d.data};c.validate=function(d){if(g)return o;
d=A(d,f);return i(d,k)};c.path=f;b.addReceiver(e,c);return c};l.model=function(a){function c(){if(arguments.length===1){m=arguments[0];i("",m)}else{var j=arguments[0],p=arguments[1];C(m,j,p);i(j,p)}}function e(j){if(j===o)return m;return A(m,j)}function b(j,p){var s,r,t,u,v,y={},E=true;if(typeof j!=="string")j="";s=0;for(r=n.length;s<r;s+=1){t=n[s];if(!(j&&t.path.indexOf(j)!==0)){y.hasOwnProperty(t.path)||(y[t.path]=[]);u=t.validate(m);if(u!==o){y[t.path].push(u);E=false}}}if(!p)for(v in y)y.hasOwnProperty(v)&&
h.sendMessage({senderId:d,path:v,signal:"error",data:y[v]});return E}function f(j){if(q){var p=q[{back:"moveBack",forward:"moveForward"}[j]](),s;if(p){s=p.path;c(s,p[{back:"oldValue",forward:"newValue"}[j]]);k(s);b(s)}}}function i(j,p){h.sendMessage({senderId:d,path:j,signal:"value",data:p})}function k(j,p){h.sendMessage({senderId:d,path:j,signal:"change",data:p||q.getStatus(j)})}a=a||{};var g={},d=a.id||w(),h=a.engine,m={},n=[],q=a.trackChanges?l.changeTracker():o;g.receiveMessage=function(j){if(j.signal===
"value"&&typeof j.path==="string"){if(q){q.push({path:j.path,oldValue:e(j.path),newValue:j.data});k(j.path)}C(m,j.path,j.data);b(j.path)}};g.set=c;g.get=e;g.validate=b;g.undo=function(){f("back")};g.redo=function(){f("forward")};g.getUndoCount=function(){if(!q)return o;return q.getBackCount()};g.getRedoCount=function(){if(!q)return o;return q.getForwardCount()};g.markSave=function(){if(q){var j,p=q.markSave();for(j=0;j<p.length;j+=1)k(p[j],"saved")}};(function(){var j=(a.metadata||{}).validationRules||
[],p,s=j.length,r;for(p=0;p<s;p+=1){r=j[p];n.push(l.validationRule({id:r.id,engine:h,path:r.path,validatorName:r.validatorName,validatorProperties:r.validatorProperties}))}})();h.addReceiver(d,g);h.addRule({receiverId:d,signal:"value"});h.addModel(g);return g};l.validators={};l.validators.required=function(a,c){if(a===o||a===null||typeof a==="string"&&(a===null||a===o?"":a.toString().replace(G,"").replace(H,""))===""||typeof a==="number"&&isNaN(a))return z(c.message||l.validationMessages.required,
c);return o};l.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};l.validators.minLength=function(a,c){if(a&&a.length!==o&&a.length<c.length)return z(c.message||l.validationMessages.minLenght,c);return o};l.validators.minLength.defaultProperty="length";l.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};l.validators.maxLength=function(a,c){if(a&&a.length!==o&&a.length>c.length)return z(c.message||
l.validationMessages.maxLenght,c);return o};l.validators.maxLength.defaultProperty="length";l.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};l.validators.minValue=function(a,c){if(a&&a<c.value)return z(c.message||l.validationMessages.minValue,c);return o};l.validators.minValue.defaultProperty="value";l.dsl.defaultElementProperties.minValue=function(a){this.element.validationRules.minValue=a;return this.chain};l.validators.maxValue=function(a,
c){if(a&&a>c.value)return z(c.message||l.validationMessages.maxValue,c);return o};l.validators.maxValue.defaultProperty="value";l.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};
l.changeTracker=function(){var a={},c=[],e=-1,b=-1;a.push=function(f){e<c.length-1&&c.splice(e+1);c.push(f);e+=1};a.moveBack=function(){if(e>=0){e-=1;return c[e+1]}return o};a.moveForward=function(){var f=c[e+1];if(f){e+=1;return f}return o};a.getBackCount=function(){return e+1};a.getForwardCount=function(){return c.length-e-1};a.getStatus=function(f){var i;for(i=e;i>=0;i-=1)if(c[i].path===f)return i<=b?"saved":"changed";return"default"};a.markSave=function(){var f,i=[];for(f=b+1;f<=e;f+=1)i.push(c[f].path);
b=e;return i};return a};l.view=function(a){function c(g){var d=(f[g.typeName]||i)({metadata:g,engine:b}),h,m;k[d.id]=d;if(g.elements&&g.elements.length){h=0;for(m=g.elements.length;h<m;h+=1)d.addElement(c(g.elements[h]))}return d}var e={},b=a.engine,f=a.elementTypes,i=a.defaultElementType||l.element,k={};e.element=c(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(g){return k[g]};return e};l.element=function(a){function c(){f.sendMessage({senderId:b.id,signal:"validation-inactive",
data:b.isHidden()||b.isReadonly()});b.notifyRequiredStatusChange();e(function(k){k.notifyValidationStatusChange()})}function e(k){var g,d;g=0;for(d=b.elements.length;g<d;g+=1)k(b.elements[g],g)}var b={},f=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors",change:"setStatus"};b.id=a.id||w();b.properties=a.properties||{};b.validationRules=a.validationRules||{};b.elements=[];b.parent=o;console.log("ctor: "+JSON.stringify(b.validationRules));
b.initialize=function(){};b.addElement=function(k){b.elements.push(k);k.parent=b};b.receiveMessage=function(k){var g=i[k.signal];g&&typeof b[g]==="function"&&b[g](k.data)};b.setValue=void 0;b.notifyValueChange=function(k){var g=b.properties.binding;if(typeof g==="string")f.sendMessage({senderId:b.id,path:g,signal:"value",data:k});else throw Error(x.elementWithoutBinding);};b.setHidden=function(k){b.hidden=k;c()};b.setReadonly=function(k){b.readonly=k;c()};b.isHidden=function(){return!!b.hidden||b.parent&&
b.parent.isHidden()};b.isReadonly=function(){return!!b.readonly};b.notifyValidationStatusChange=c;b.showErrors=function(){};b.notifyRequiredStatusChange=function(){b.markRequired("required"in b.validationRules&&!b.isHidden()&&!b.isReadonly())};b.markRequired=function(){};b.eachChild=e;f.addReceiver(b.id,b);return b};l.expressionParser=function(a){for(var c={args:[]},e=[],b=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,f,i=a;(f=b.exec(a))!==null;){e.push(f[0]);c.args.push(f[1])}a=0;for(b=e.length;a<
b;a+=1)i=i.replace(e[a],"arguments["+a+"]");c.processor=new Function("return "+i+";");return c};l.metadataProvider=function(a){function c(h,m){var n,q,j;m=m||f;m.id=h.id||w();m.typeName=h.typeName;m.properties=h.properties||{};j=m;var p,s,r,t,u,v;p=0;for(s=g.length;p<s;p+=1){r=g[p];t=h[r];if(typeof t==="string"){t=d(t);u=w();v={id:u,type:"expression",processorArgs:t.args,processor:t.processor,signal:r};k.push(v);i.push({receiverId:u,path:t.args,signal:"value"});i.push({receiverId:j.id,senderId:u,
signal:r});if(r==="value"){u=w();v={id:u,type:"change",processorArgs:t.args,signal:"change"};k.push(v);i.push({receiverId:u,path:t.args,signal:"change"});i.push({receiverId:j.id,senderId:u,signal:"change"})}}}if(typeof h.binding==="string"){m.properties.binding=h.binding;j=m;p=h.binding;s=h.validationRules||{};j.validationRules={};for(n in s)if(s.hasOwnProperty(n)){r=l.validators[n];if(r===o)throw Error(x.unknownValidator+n);if(typeof s[n]==="object")q=s[n];else if(typeof r.defaultProperty==="string"){q=
{};q[r.defaultProperty]=s[n]}r=w();b.validationRules.push({id:r,path:p,validatorName:n,validatorProperties:q});j.validationRules[n]=q||{};i.push({receiverId:r,senderId:j.id,signal:"validation-inactive"})}i.push({receiverId:m.id,path:h.binding,signal:["value","error","change"]})}if(h.elements&&h.elements.length){m.elements=[];n=0;for(q=h.elements.length;n<q;n+=1){j={};c(h.elements[n],j,m);m.elements.push(j)}}}var e={},b={validationRules:[]},f={},i=[],k=[],g=a.expressionProperties||["value","hidden",
"readonly"],d=a.expressionParser||l.expressionParser;e.getModelMetadata=function(){return b};e.getViewMetadata=function(){return f};e.getRules=function(){return i};e.getTriggers=function(){return k};c(a.metadata);return e};F.fe=l})(function(){return this}());
