(function(F,o){function v(){B+=1;return"i"+B}function A(a,c){var e,b,h,i;e=c.split(".");i=a;b=0;for(h=e.length;b<h;b+=1){i=i[e[b]];if(i===o||i===null)return o}return i}function C(a,c,e){c=c.split(".");var b=c.length-1,h=a;for(a=0;a<b;a+=1){h=h[c[a]];if(h===o)return}h[c[b]]=e}function D(a,c){var e,b=a.length,h,i;for(e=0;e<b;e+=1)if(typeof a[e].length==="number"){h=0;for(i=a[e].length;h<i;h+=1)c(a[e][h])}else c(a[e])}function z(a,c){var e;a=a||"";for(e in c)if(c.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),c[e]);return a}var j={version:"0.0.1"},B=0,G=/^\s+/,H=/\s+$/,w={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};j.dsl={};j.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,c){this.element.properties[a]=c;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};j.dsl.elementConstructor=function(a,c,e){function b(h,i,k){function g(f,m){h[f]=function(){return m.apply(k,arguments)}}for(var d in i)i.hasOwnProperty(d)&&g(d,i[d])}c=c||{};c.defaultProperty=c.defaultProperty||"binding";e=e||{};return function(){function h(){var g,d=arguments.length,f;for(g=0;g<d;g+=1){f=arguments[g];if(typeof f==="function"&&typeof f.get===
"function")i.elements.push(f.get());else if(g===0&&typeof c.defaultProperty==="string")i[c.defaultProperty]=f}return h}var i={typeName:a,properties:{},validationRules:{},elements:[]},k={element:i,chain:h,params:c};typeof c.initialize==="function"&&c.initialize.apply(k);b(h,j.dsl.defaultElementProperties,k);b(h,e,k);return h.apply(o,arguments)}};j.rule=function(a){function c(d,f,m){if(d)e[f]=function(n){var r,l;if(typeof d==="string")return m?d.indexOf(n)===0:d===n;if(typeof d==="object"&&d.length){r=
0;for(l=d.length;r<l;r+=1)if(m?d[r].indexOf(n)===0:d[r]===n)return true;return false}return true}}var e={},b=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],i=[false,true,false],k,g;e.receiverId=a.receiverId;e.path=a.path;k=0;for(g=b.length;k<g;k+=1)c(a[b[k]],h[k],i[k]);e.transformData=function(d,f){var m;if(d!==o&&typeof f==="string"&&typeof a.path==="string"&&a.path.length>f.length){m=f.length;return A(d,a.path.slice(m>0?m+1:m))}return d};return e};j.trigger=function(a){var c=
{},e=a.id,b=a.engine,h=a.processor,i=a.processorArgs,k=a.signal;c.receiveMessage=function(){var g=[],d,f=i.length;for(d=0;d<f;d+=1)g.push(b.get(i[d]));g=h.apply(o,g);b.sendMessage({senderId:e,signal:k,data:g})};b.addReceiver(e,c);return c};j.engine=function(){function a(d,f){if(typeof d!=="string")throw Error(w.receiverIdMustBeString);if(!f||typeof f!=="function"&&typeof f.receiveMessage!=="function")throw Error(w.noReceiveMessageMethod);if(d in h)throw Error(w.notUniqueReceiverId);h[d]=typeof f!==
"function"?f:{receiveMessage:f}}function c(d){if(typeof d.receiverId!=="string")throw Error(w.noReceiverId);i.push(j.rule(d))}function e(d){d.engine=b;k.push(j.trigger(d))}var b={},h={},i=[],k=[],g=[];b.addReceiver=a;b.addRule=c;b.addRules=function(){D(arguments,c)};b.addTrigger=e;b.addTriggers=function(){D(arguments,e)};b.addModel=function(d){g.push(d)};b.sendMessage=function(d){var f,m=i.length,n;for(f=0;f<m;f+=1){n=i[f];if(d.senderId!==n.receiverId)if((!n.checkSender||n.checkSender(d.senderId))&&
(!n.checkPath||n.checkPath(d.path))&&(!n.checkSignal||n.checkSignal(d.signal))){if(!(n.receiverId in h))throw Error(w.receiverNotFound);h[n.receiverId].receiveMessage({senderId:d.senderId,path:d.path,rulePath:n.path,signal:d.signal,data:n.transformData(d.data,d.path)})}}};b.get=function(d){var f,m,n;f=0;for(m=g.length;f<m;f+=1){n=g[f].get(d);if(n!==o)return n}return o};b.subscribe=function(d,f){var m=v();a(m,f);d.receiverId=m;c(d)};return b};j.validationRule=function(a){var c={},e=a.id||v(),b=a.engine,
h=a.path,i=j.validators[a.validatorName],k=a.validatorProperties||{},g;c.receiveMessage=function(d){if(d.signal==="validation-inactive")g=d.data};c.validate=function(d){if(g)return o;d=A(d,h);return i(d,k)};c.path=h;b.addReceiver(e,c);return c};j.model=function(a){function c(){if(arguments.length===1){m=arguments[0];i("",m)}else{var l=arguments[0],p=arguments[1];C(m,l,p);i(l,p)}}function e(l){if(l===o)return m;return A(m,l)}function b(l,p){var s,q,t,u,x,y={},E=true;if(typeof l!=="string")l="";s=0;
for(q=n.length;s<q;s+=1){t=n[s];if(!(l&&t.path.indexOf(l)!==0)){y.hasOwnProperty(t.path)||(y[t.path]=[]);u=t.validate(m);if(u!==o){y[t.path].push(u);E=false}}}if(!p)for(x in y)y.hasOwnProperty(x)&&f.sendMessage({senderId:d,path:x,signal:"error",data:y[x]});return E}function h(l){var p=r[{back:"moveBack",forward:"moveForward"}[l]]();if(p){c(p.path,p[{back:"oldValue",forward:"newValue"}[l]]);k(p.path)}}function i(l,p){f.sendMessage({senderId:d,path:l,signal:"value",data:p})}function k(l){f.sendMessage({senderId:d,
path:l,signal:"change",data:r.getStatus(l)})}a=a||{};var g={},d=a.id||v(),f=a.engine,m={},n=[],r=j.changeTracker();g.receiveMessage=function(l){if(l.signal==="value"&&typeof l.path==="string"){r.push({path:l.path,oldValue:e(l.path),newValue:l.data});k(l.path);C(m,l.path,l.data);b(l.path)}};g.set=c;g.get=e;g.validate=b;g.undo=function(){h("back")};g.redo=function(){h("forward")};g.getUndoCount=function(){return r.getBackCount()};g.getRedoCount=function(){return r.getForwardCount()};(function(){var l=
(a.metadata||{}).validationRules||[],p,s=l.length,q;for(p=0;p<s;p+=1){q=l[p];n.push(j.validationRule({id:q.id,engine:f,path:q.path,validatorName:q.validatorName,validatorProperties:q.validatorProperties}))}})();f.addReceiver(d,g);f.addRule({receiverId:d,signal:"value"});f.addModel(g);return g};j.validators={};j.validators.required=function(a,c){if(a===o||a===null||typeof a==="string"&&(a===null||a===o?"":a.toString().replace(G,"").replace(H,""))===""||typeof a==="number"&&isNaN(a))return z(c.message||
j.validationMessages.required,c);return o};j.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};j.validators.minLength=function(a,c){if(a&&a.length!==o&&a.length<c.length)return z(c.message||j.validationMessages.minLenght,c);return o};j.validators.minLength.defaultProperty="length";j.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};j.validators.maxLength=function(a,c){if(a&&
a.length!==o&&a.length>c.length)return z(c.message||j.validationMessages.maxLenght,c);return o};j.validators.maxLength.defaultProperty="length";j.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};j.validators.minValue=function(a,c){if(a&&a<c.value)return z(c.message||j.validationMessages.minValue,c);return o};j.validators.minValue.defaultProperty="value";j.dsl.defaultElementProperties.minValue=function(a){this.element.validationRules.minValue=
a;return this.chain};j.validators.maxValue=function(a,c){if(a&&a>c.value)return z(c.message||j.validationMessages.maxValue,c);return o};j.validators.maxValue.defaultProperty="value";j.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};j.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",
maxValue:"This field should have value less that {value}!"};j.changeTracker=function(){var a={},c=[],e=-1;a.push=function(b){e<c.length-1&&c.splice(e+1);c.push(b);e+=1};a.moveBack=function(){if(e>=0){e-=1;return c[e+1]}return o};a.moveForward=function(){var b=c[e+1];if(b){e+=1;return b}return o};a.getBackCount=function(){return e+1};a.getForwardCount=function(){return c.length-e-1};a.getStatus=function(b){var h;for(h=e;h>=0;h-=1)if(c[h].path===b)return"changed";return"default"};return a};j.view=function(a){function c(g){var d=
(h[g.typeName]||i)({metadata:g,engine:b}),f,m;k[d.id]=d;if(g.elements&&g.elements.length){f=0;for(m=g.elements.length;f<m;f+=1)d.addElement(c(g.elements[f]))}return d}var e={},b=a.engine,h=a.elementTypes,i=a.defaultElementType||j.element,k={};e.element=c(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(g){return k[g]};return e};j.element=function(a){function c(){h.sendMessage({senderId:b.id,signal:"validation-inactive",data:b.isHidden()||b.isReadonly()});e(function(k){k.notifyValidationStatusChange()})}
function e(k){var g,d;g=0;for(d=b.elements.length;g<d;g+=1)k(b.elements[g],g)}var b={},h=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors",change:"setStatus"};b.id=a.id||v();b.properties=a.properties||{};b.elements=[];b.parent=o;b.initialize=function(){};b.addElement=function(k){b.elements.push(k);k.parent=b};b.receiveMessage=function(k){var g=i[k.signal];g&&typeof b[g]==="function"&&b[g](k.data)};b.setValue=void 0;b.notifyValueChange=function(k){var g=
b.properties.binding;if(typeof g==="string")h.sendMessage({senderId:b.id,path:g,signal:"value",data:k});else throw Error(w.elementWithoutBinding);};b.setHidden=function(k){b.hidden=k;c()};b.setReadonly=function(k){b.readonly=k;c()};b.isHidden=function(){return!!b.hidden||b.parent&&b.parent.isHidden()};b.isReadonly=function(){return!!b.readonly};b.notifyValidationStatusChange=c;b.showErrors=function(){};b.eachChild=e;h.addReceiver(b.id,b);return b};j.expressionParser=function(a){for(var c={args:[]},
e=[],b=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,h,i=a;(h=b.exec(a))!==null;){e.push(h[0]);c.args.push(h[1])}a=0;for(b=e.length;a<b;a+=1)i=i.replace(e[a],"arguments["+a+"]");c.processor=new Function("return "+i+";");return c};j.metadataProvider=function(a){function c(f,m){var n,r,l;m=m||h;m.id=f.id||v();m.typeName=f.typeName;m.properties=f.properties||{};l=m;var p,s,q,t,u,x;p=0;for(s=g.length;p<s;p+=1){q=g[p];t=f[q];if(typeof t==="string"){t=d(t);u=v();x={id:u,processorArgs:t.args,processor:t.processor,
signal:q};k.push(x);i.push({receiverId:u,path:t.args,signal:"value"});i.push({receiverId:l.id,senderId:u,signal:q})}}if(typeof f.binding==="string"){m.properties.binding=f.binding;l=m;p=f.binding;s=f.validationRules||{};for(n in s)if(s.hasOwnProperty(n)){q=j.validators[n];if(q===o)throw Error(w.unknownValidator+n);if(typeof s[n]==="object")r=s[n];else if(typeof q.defaultProperty==="string"){r={};r[q.defaultProperty]=s[n]}q=v();b.validationRules.push({id:q,path:p,validatorName:n,validatorProperties:r});
i.push({receiverId:q,senderId:l.id,signal:"validation-inactive"})}i.push({receiverId:m.id,path:f.binding,signal:["value","error","change"]})}if(f.elements&&f.elements.length){m.elements=[];n=0;for(r=f.elements.length;n<r;n+=1){l={};c(f.elements[n],l,m);m.elements.push(l)}}}var e={},b={validationRules:[]},h={},i=[],k=[],g=a.expressionProperties||["value","hidden","readonly"],d=a.expressionParser||j.expressionParser;e.getModelMetadata=function(){return b};e.getViewMetadata=function(){return h};e.getRules=
function(){return i};e.getTriggers=function(){return k};c(a.metadata);return e};F.fe=j})(function(){return this}());
