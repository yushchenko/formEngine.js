(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var f,b,g,j;f=d.split(".");j=a;b=0;for(g=f.length;b<g;b+=1){j=j[f[b]];if(j===n||j===null)return n}return j}function A(a,d,f){d=d.split(".");var b=d.length-1,g=a;for(a=0;a<b;a+=1){g=g[d[a]];if(g===n)return}g[d[b]]=f}function B(a,d){var f,b=a.length,g,j;for(f=0;f<b;f+=1)if(typeof a[f].length==="number"){g=0;for(j=a[f].length;g<j;g+=1)d(a[f][g])}else d(a[f])}function w(a,d){var f;a=a||"";for(f in d)if(d.hasOwnProperty(f))a=a.replace(RegExp("{"+
f+"}","g"),d[f]);return a}var l={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.dsl={};l.dsl.defaultMethods={id:function(a){this.element.id=a;return this.chain},property:function(a,d){this.element.properties[a]=d;return this.chain},label:function(a){return l.dsl.defaultMethods.property("label",a)},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=a;return this.chain},get:function(){return this.element}};l.dsl.token=
function(a,d){function f(b,g,j){function h(c,e){b[c]=function(){return e.apply(j,arguments)}}for(var i in g)g.hasOwnProperty(i)&&h(i,g[i])}return function(){function b(){var h,i=arguments.length,c;for(h=0;h<i;h+=1){c=arguments[h];typeof c==="function"&&typeof c.get==="function"&&g.elements.push(c.get())}return b}var g={properties:{},validationRules:{},elements:[]};typeof a==="function"&&a(g);var j={element:g,chain:b};f(b,l.dsl.defaultMethods,j);f(b,d||{},j);return b.apply(n,arguments)}};l.dsl.element=
l.dsl.token();l.rule=function(a){function d(c,e,m){if(c)f[e]=function(k){var o,q;if(typeof c==="string")return m?c.indexOf(k)===0:c===k;if(typeof c==="object"&&c.length){o=0;for(q=c.length;o<q;o+=1)if(m?c[o].indexOf(k)===0:c[o]===k)return true;return false}return true}}var f={},b=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],j=[false,true,false],h,i;f.receiverId=a.receiverId;f.path=a.path;h=0;for(i=b.length;h<i;h+=1)d(a[b[h]],g[h],j[h]);f.transformData=function(c,e){var m;
if(c!==n&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){m=e.length;return y(c,a.path.slice(m>0?m+1:m))}return c};return f};l.trigger=function(a){var d={},f=a.id,b=a.engine,g=a.processor,j=a.processorArgs,h=a.signal;d.receiveMessage=function(){var i=[],c,e=j.length;for(c=0;c<e;c+=1)i.push(b.get(j[c]));i=g.apply(n,i);b.sendMessage({senderId:f,signal:h,data:i})};b.addReceiver(f,d);return d};l.engine=function(){function a(c,e){if(typeof c!=="string")throw Error(u.receiverIdMustBeString);
if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(c in g)throw Error(u.notUniqueReceiverId);g[c]=typeof e!=="function"?e:{receiveMessage:e}}function d(c){if(typeof c.receiverId!=="string")throw Error(u.noReceiverId);j.push(l.rule(c))}function f(c){c.engine=b;h.push(l.trigger(c))}var b={},g={},j=[],h=[],i=[];b.addReceiver=a;b.addRule=d;b.addRules=function(){B(arguments,d)};b.addTrigger=f;b.addTriggers=function(){B(arguments,f)};b.addModel=function(c){i.push(c)};
b.sendMessage=function(c){var e,m=j.length,k;for(e=0;e<m;e+=1){k=j[e];if(c.senderId!==k.receiverId)if((!k.checkSender||k.checkSender(c.senderId))&&(!k.checkPath||k.checkPath(c.path))&&(!k.checkSignal||k.checkSignal(c.signal))){if(!(k.receiverId in g))throw Error(u.receiverNotFound);g[k.receiverId].receiveMessage({senderId:c.senderId,path:c.path,rulePath:k.path,signal:c.signal,data:k.transformData(c.data,c.path)})}}};b.get=function(c){var e,m,k;e=0;for(m=i.length;e<m;e+=1){k=i[e].get(c);if(k!==n)return k}return n};
b.subscribe=function(c,e){var m=t();a(m,e);c.receiverId=m;d(c)};return b};l.validationRule=function(a){var d={},f=a.id||t(),b=a.engine,g=a.path,j=l.validators[a.validatorName],h=a.validatorProperties||{},i;d.receiveMessage=function(c){if(c.signal==="validation-inactive")i=c.data};d.validate=function(c){if(i)return n;c=y(c,g);return j(c,h)};d.path=g;b.addReceiver(f,d);return d};l.model=function(a){function d(c,e){var m,k,o,q,s,p={},r=true;if(typeof c!=="string")c="";m=0;for(k=i.length;m<k;m+=1){o=
i[m];if(!(c&&o.path.indexOf(c)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(h);if(q!==n){p[o.path].push(q);r=false}}}if(!e)for(s in p)p.hasOwnProperty(s)&&j.sendMessage({senderId:g,path:s,signal:"error",data:p[s]});return r}function f(c,e){j.sendMessage({senderId:g,path:c,signal:"value",data:e})}a=a||{};var b={},g=a.id||t(),j=a.engine,h={},i=[];b.receiveMessage=function(c){if(c.signal==="value"&&typeof c.path==="string"){A(h,c.path,c.data);d(c.path)}};b.set=function(){if(arguments.length===
1){h=arguments[0];f("",h)}else{var c=arguments[0],e=arguments[1];A(h,c,e);f(c,e)}};b.get=function(c){if(c===n)return h;return y(h,c)};b.validate=d;(function(){var c=(a.metadata||{}).validationRules||[],e,m=c.length,k;for(e=0;e<m;e+=1){k=c[e];i.push(l.validationRule({id:k.id,engine:j,path:k.path,validatorName:k.validatorName,validatorProperties:k.validatorProperties}))}})();j.addReceiver(g,b);j.addRule({receiverId:g,signal:"value"});j.addModel(b);return b};l.validators={};l.validators.required=function(a,
d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||l.validationMessages.required,d);return n};l.validators.minLength=function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||l.validationMessages.minLenght,d);return n};l.validators.minLength.defaultProperty="length";l.validators.maxLength=function(a,d){if(a&&a.length!==n&&a.length>d.length)return w(d.message||l.validationMessages.maxLenght,
d);return n};l.validators.maxLength.defaultProperty="length";l.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||l.validationMessages.minValue,d);return n};l.validators.minValue.defaultProperty="value";l.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||l.validationMessages.maxValue,d);return n};l.validators.maxValue.defaultProperty="value";l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",
maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};l.view=function(a){function d(i){var c=(g[i.typeName]||j)({metadata:i,engine:b}),e,m;h[c.id]=c;if(i.children&&i.children.length){e=0;for(m=i.children.length;e<m;e+=1)c.addElement(d(i.children[e]))}return c}var f={},b=a.engine,g=a.elementTypes,j=a.defaultElementType||l.element,h={};f.element=d(a.metadata);f.initialize=
function(){f.element.initialize()};f.getElementById=function(i){return h[i]};return f};l.element=function(a){function d(){g.sendMessage({senderId:b.id,signal:"validation-inactive",data:b.isHidden()||b.isReadonly()});f(function(h){h.notifyValidationStatusChange()})}function f(h){var i,c;i=0;for(c=b.children.length;i<c;i+=1)h(b.children[i],i)}var b={},g=a.engine;a=a.metadata||{};var j={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};b.id=a.id||t();b.properties=a.properties||
{};b.children=[];b.parent=n;b.initialize=function(){};b.addElement=function(h){b.children.push(h);h.parent=b};b.receiveMessage=function(h){var i=j[h.signal];i&&typeof b[i]==="function"&&b[i](h.data)};b.setValue=void 0;b.notifyValueChange=function(h){var i=b.properties.binding;if(typeof i==="string")g.sendMessage({senderId:b.id,path:i,signal:"value",data:h});else throw Error(u.elementWithoutBinding);};b.setHidden=function(h){b.hidden=h;d()};b.setReadonly=function(h){b.readonly=h;d()};b.isHidden=function(){return!!b.hidden||
b.parent&&b.parent.isHidden()};b.isReadonly=function(){return!!b.readonly};b.notifyValidationStatusChange=d;b.showErrors=function(){};b.eachChild=f;g.addReceiver(b.id,b);return b};l.expressionParser=function(a){for(var d={args:[]},f=[],b=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,g,j=a;(g=b.exec(a))!==null;){f.push(g[0]);d.args.push(g[1])}a=0;for(b=f.length;a<b;a+=1)j=j.replace(f[a],"arguments["+a+"]");d.processor=new Function("return "+j+";");return d};l.metadataProvider=function(a){function d(e,
m){var k,o,q;m=m||g;m.id=e.id||t();m.typeName=e.typeName;m.properties=e.properties||{};q=m;var s,p,r,v,x,C;s=0;for(p=i.length;s<p;s+=1){r=i[s];v=e[r];if(typeof v==="string"){v=c(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};h.push(C);j.push({receiverId:x,path:v.args,signal:"value"});j.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof e.binding==="string"){m.properties.binding=e.binding;q=m;s=e.binding;p=e.validationRules||{};for(k in p)if(p.hasOwnProperty(k)){r=l.validators[k];
if(r===n)throw Error(u.unknownValidator+k);if(typeof p[k]==="object")o=p[k];else if(typeof r.defaultProperty==="string"){o={};o[r.defaultProperty]=p[k]}r=t();b.validationRules.push({id:r,path:s,validatorName:k,validatorProperties:o});j.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}j.push({receiverId:m.id,path:e.binding,signal:["value","error"]})}if(e.children&&e.children.length){m.children=[];k=0;for(o=e.children.length;k<o;k+=1){q={};d(e.children[k],q,m);m.children.push(q)}}}var f=
{},b={validationRules:[]},g={},j=[],h=[],i=a.expressionProperties||["value","hidden","readonly"],c=a.expressionParser||l.expressionParser;f.getModelMetadata=function(){return b};f.getViewMetadata=function(){return g};f.getRules=function(){return j};f.getTriggers=function(){return h};d(a.metadata);return f};D.fe=l})(function(){return this}());
