(function(A,q){function t(){v+=1;return"i"+v}function w(b,d){var c,h,g,e;c=d.split(".");e=b;h=0;for(g=c.length;h<g;h+=1){e=e[c[h]];if(e===q)return q}return e}function x(b,d,c){d=d.split(".");var h=d.length-1,g=b;for(b=0;b<h;b+=1){g=g[d[b]];if(g===q)return}g[d[h]]=c}function y(b,d){var c,h=b.length,g,e;for(c=0;c<h;c+=1)if(typeof b[c].length==="number"){g=0;for(e=b[c].length;g<e;g+=1)d(b[c][g])}else d(b[c])}var o={version:"0.0.1"},v=0,s={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",
receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined."};o.rule=function(b){function d(a,f,k){if(a)c[f]=function(l){var m,n;if(typeof a==="string")return k?
a.indexOf(l)===0:a===l;if(typeof a==="object"&&a.length){m=0;for(n=a.length;m<n;m+=1)if(k?a[m].indexOf(l)===0:a===l[m])return true;return false}return true}}var c={},h=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],e=[false,true,false],i,j;c.receiverId=b.receiverId;c.path=b.path;i=0;for(j=h.length;i<j;i+=1)d(b[h[i]],g[i],e[i]);c.transformData=function(a,f){var k;if(a!==q&&typeof f==="string"&&typeof b.path==="string"&&b.path.length>f.length){k=f.length;return w(a,b.path.slice(k>
0?k+1:k))}return a};return c};o.trigger=function(b){var d={},c=b.id,h=b.engine,g=b.processor,e=b.processorArgs,i=b.signal;d.receiveMessage=function(){var j=[],a,f=e.length;for(a=0;a<f;a+=1)j.push(h.get(e[a]));j=g.apply(q,j);h.sendMessage({senderId:c,signal:i,data:j})};h.addReceiver(c,d);return d};o.engine=function(){function b(a,f){if(typeof a!=="string")throw Error(s.receiverIdMustBeString);if(!f||typeof f!=="function"&&typeof f.receiveMessage!=="function")throw Error(s.noReceiveMessageMethod);if(a in
g)throw Error(s.notUniqueReceiverId);g[a]=typeof f!=="function"?f:{receiveMessage:f}}function d(a){if(typeof a.receiverId!=="string")throw Error(s.noReceiverId);e.push(o.rule(a))}function c(a){a.engine=h;i.push(o.trigger(a))}var h={},g={},e=[],i=[],j=[];h.addReceiver=b;h.addRule=d;h.addRules=function(){y(arguments,d)};h.addTrigger=c;h.addTriggers=function(){y(arguments,c)};h.addModel=function(a){j.push(a)};h.sendMessage=function(a){var f,k=e.length,l;for(f=0;f<k;f+=1){l=e[f];if(a.senderId!==l.receiverId)if((!l.checkSender||
l.checkSender(a.senderId))&&(!l.checkPath||l.checkPath(a.path))&&(!l.checkSignal||l.checkSignal(a.signal))){if(!(l.receiverId in g))throw Error(s.receiverNotFound);g[l.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:l.path,signal:a.signal,data:l.transformData(a.data,a.path)})}}};h.get=function(a){var f,k,l;f=0;for(k=j.length;f<k;f+=1){l=j[f].get(a);if(l!==q)return l}return q};h.subscribe=function(a,f){var k=t();b(k,f);a.receiverId=k;d(a)};return h};o.model=function(b){function d(i,
j){g&&g.sendMessage({senderId:h,path:i,signal:"value",data:j})}b=b||{};var c={},h=b.id||t(),g=b.engine,e={};c.receiveMessage=function(i){i.signal==="value"&&typeof i.path==="string"&&x(e,i.path,i.data)};c.set=function(){if(arguments.length===1){e=arguments[0];d("",e)}else{var i=arguments[0],j=arguments[1];x(e,i,j);d(i,j)}};c.get=function(i){if(i===q)return e;return w(e,i)};if(g){g.addReceiver(h,c);g.addRule({receiverId:h,signal:"value"});g.addModel(c)}return c};o.view=function(b){function d(j){var a=
(g[j.typeName]||e)({metadata:j,engine:h}),f,k;i[a.id]=a;if(j.children&&j.children.length){f=0;for(k=j.children.length;f<k;f+=1)a.children.push(d(j.children[f]))}return a}var c={},h=b.engine,g=b.elementTypes,e=b.defaultElementType||o.element,i={};c.element=d(b.metadata);c.initialize=function(){c.element.initialize()};c.getElementById=function(j){return i[j]};return c};o.element=function(b){var d={},c=b.engine;b=b.metadata||{};var h={value:"setValue",hidden:"setHidden",readonly:"setReadonly"};d.id=
b.id||t();d.properties=b.properties||{};d.children=[];d.initialize=function(){};d.receiveMessage=function(g){var e=h[g.signal];e&&typeof d[e]==="function"&&d[e](g.data)};d.notifyValueChange=function(g){var e=d.properties.binding;if(typeof e==="string")c.sendMessage({senderId:d.id,path:e,signal:"value",data:g});else throw Error(s.elementWithoutBinding);};d.eachChild=function(g){var e,i;e=0;for(i=d.children.length;e<i;e+=1)g(d.children[e],e)};c.addReceiver(d.id,d);return d};o.metadataProvider=function(b){function d(a,
f){var k,l,m,n,p;f=f||g;f.id=a.id||t();f.typeName=a.typeName;f.properties=a.properties||{};if(a.children&&a.children.length){f.children=[];k=0;for(l=a.children.length;k<l;k+=1){m={};d(a.children[k],m);f.children.push(m)}}if(typeof a.binding==="string"){e.push({receiverId:f.id,path:a.binding,signal:"value"});f.properties.binding=a.binding}k=0;for(l=j.length;k<l;k+=1){m=j[k];n=a[m];if(typeof n==="string"){n=n;p={args:[]};var B=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,u=n;r=void 0;for(var z=
void 0;(r=B.exec(n))!==null;)p.args.push(r[0]);r=0;for(z=p.args.length;r<z;r+=1)u=u.replace(p.args[r],"arguments["+r+"]");p.processor=new Function("return "+u+";");n=p;p=t();i.push({id:p,processorArgs:n.args,processor:n.processor,signal:m});e.push({receiverId:p,path:n.args,signal:"value"});e.push({receiverId:f.id,senderId:p,signal:m})}}}var c={},h=[],g={},e=[],i=[],j=["hidden","readonly"];c.getModelMetadata=function(){return h};c.getViewMetadata=function(){return g};c.getRules=function(){return e};
c.getTriggers=function(){return i};d(b.metadata);return c};A.fe=o})(function(){return this}());
