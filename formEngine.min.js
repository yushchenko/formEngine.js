(function(C,q){function u(){y+=1;return"i"+y}function v(b,c){var e,g,h,f;e=c.split(".");f=b;g=0;for(h=e.length;g<h;g+=1){f=f[e[g]];if(f===q)return q}return f}function z(b,c,e){c=c.split(".");var g=c.length-1,h=b;for(b=0;b<g;b+=1){h=h[c[b]];if(h===q)return}h[c[g]]=e}function A(b,c){var e,g=b.length,h,f;for(e=0;e<g;e+=1)if(typeof b[e].length==="number"){h=0;for(f=b[e].length;h<f;h+=1)c(b[e][h])}else c(b[e])}function w(b,c){var e;b=b||"";for(e in c)if(c.hasOwnProperty(e))b=b.replace(RegExp("{"+e+"}",
"g"),c[e]);return b}var n={version:"0.0.1"},y=0,D=/^\s+/,E=/\s+$/,t={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};n.rule=function(b){function c(a,d,i){if(a)e[d]=function(k){var j,o;if(typeof a==="string")return i?a.indexOf(k)===0:a===k;if(typeof a==="object"&&a.length){j=0;for(o=a.length;j<o;j+=1)if(i?a[j].indexOf(k)===0:a[j]===k)return true;return false}return true}}var e={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],f=[false,true,false],l,m;e.receiverId=b.receiverId;e.path=b.path;l=0;for(m=g.length;l<m;l+=1)c(b[g[l]],
h[l],f[l]);e.transformData=function(a,d){var i;if(a!==q&&typeof d==="string"&&typeof b.path==="string"&&b.path.length>d.length){i=d.length;return v(a,b.path.slice(i>0?i+1:i))}return a};return e};n.trigger=function(b){var c={},e=b.id,g=b.engine,h=b.processor,f=b.processorArgs,l=b.signal;c.receiveMessage=function(){var m=[],a,d=f.length;for(a=0;a<d;a+=1)m.push(g.get(f[a]));m=h.apply(q,m);g.sendMessage({senderId:e,signal:l,data:m})};g.addReceiver(e,c);return c};n.engine=function(){function b(a,d){if(typeof a!==
"string")throw Error(t.receiverIdMustBeString);if(!d||typeof d!=="function"&&typeof d.receiveMessage!=="function")throw Error(t.noReceiveMessageMethod);if(a in h)throw Error(t.notUniqueReceiverId);h[a]=typeof d!=="function"?d:{receiveMessage:d}}function c(a){if(typeof a.receiverId!=="string")throw Error(t.noReceiverId);f.push(n.rule(a))}function e(a){a.engine=g;l.push(n.trigger(a))}var g={},h={},f=[],l=[],m=[];g.addReceiver=b;g.addRule=c;g.addRules=function(){A(arguments,c)};g.addTrigger=e;g.addTriggers=
function(){A(arguments,e)};g.addModel=function(a){m.push(a)};g.sendMessage=function(a){var d,i=f.length,k;for(d=0;d<i;d+=1){k=f[d];if(a.senderId!==k.receiverId)if((!k.checkSender||k.checkSender(a.senderId))&&(!k.checkPath||k.checkPath(a.path))&&(!k.checkSignal||k.checkSignal(a.signal))){if(!(k.receiverId in h))throw Error(t.receiverNotFound);h[k.receiverId].receiveMessage({senderId:a.senderId,path:a.path,rulePath:k.path,signal:a.signal,data:k.transformData(a.data,a.path)})}}};g.get=function(a){var d,
i,k;d=0;for(i=m.length;d<i;d+=1){k=m[d].get(a);if(k!==q)return k}return q};g.subscribe=function(a,d){var i=u();b(i,d);a.receiverId=i;c(a)};return g};n.model=function(b){function c(a,d){var i,k,j,o,p,s={},r=true;if(typeof a!=="string")a="";i=0;for(k=m.length;i<k;i+=1){j=m[i];if(!(a&&j.path.indexOf(a)!==0)){s.hasOwnProperty(j.path)||(s[j.path]=[]);o=n.validators[j.validatorName];o=o(v(l,j.path),j.validatorProperties||{});if(o!==q){s[j.path].push(o);r=false}}}if(!d)for(p in s)s.hasOwnProperty(p)&&f.sendMessage({senderId:h,
path:p,signal:"error",data:s[p]});return r}function e(a,d){f.sendMessage({senderId:h,path:a,signal:"value",data:d})}b=b||{};var g={},h=b.id||u(),f=b.engine,l={},m=(b.metadata||{}).validationRules||[];g.receiveMessage=function(a){if(a.signal==="value"&&typeof a.path==="string"){z(l,a.path,a.data);c(a.path)}};g.set=function(){if(arguments.length===1){l=arguments[0];e("",l)}else{var a=arguments[0],d=arguments[1];z(l,a,d);e(a,d)}};g.get=function(a){if(a===q)return l;return v(l,a)};g.validate=c;if(f){f.addReceiver(h,
g);f.addRule({receiverId:h,signal:"value"});f.addModel(g)}return g};n.validators={};n.validators.required=function(b,c){if(b===q||b===null||typeof b==="string"&&(b===null||b===q?"":b.toString().replace(D,"").replace(E,""))===""||typeof b==="number"&&isNaN(b))return w(c.message||n.validationMessages.required,c);return q};n.validators.minLength=function(b,c){if(b&&b.length!==q&&b.length<c.length)return w(c.message||n.validationMessages.minLenght,c);return q};n.validators.minLength.defaultProperty="length";
n.validators.maxLength=function(b,c){if(b&&b.length!==q&&b.length>c.length)return w(c.message||n.validationMessages.maxLenght,c);return q};n.validators.maxLength.defaultProperty="length";n.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!"};n.view=function(b){function c(m){var a=(h[m.typeName]||f)({metadata:m,engine:g}),d,i;l[a.id]=a;if(m.children&&m.children.length){d=
0;for(i=m.children.length;d<i;d+=1)a.children.push(c(m.children[d]))}return a}var e={},g=b.engine,h=b.elementTypes,f=b.defaultElementType||n.element,l={};e.element=c(b.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(m){return l[m]};return e};n.element=function(b){var c={},e=b.engine;b=b.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=b.id||u();c.properties=b.properties||{};c.children=[];c.initialize=function(){};
c.receiveMessage=function(h){var f=g[h.signal];f&&typeof c[f]==="function"&&c[f](h.data)};c.notifyValueChange=function(h){var f=c.properties.binding;if(typeof f==="string")e.sendMessage({senderId:c.id,path:f,signal:"value",data:h});else throw Error(t.elementWithoutBinding);};c.eachChild=function(h){var f,l;f=0;for(l=c.children.length;f<l;f+=1)h(c.children[f],f)};e.addReceiver(c.id,c);return c};n.metadataProvider=function(b){function c(a,d){var i,k,j,o,p;d=d||h;d.id=a.id||u();d.typeName=a.typeName;
d.properties=a.properties||{};if(a.children&&a.children.length){d.children=[];i=0;for(k=a.children.length;i<k;i+=1){j={};c(a.children[i],j);d.children.push(j)}}if(typeof a.binding==="string"){d.properties.binding=a.binding;i=a.validationRules||{};k=a.binding;for(o in i)if(i.hasOwnProperty(o)){j=n.validators[o];if(j===q)throw Error(t.unknownValidator+o);if(typeof i[o]==="object")p=i[o];else if(typeof j.defaultProperty==="string"){p={};p[j.defaultProperty]=i[o]}g.validationRules.push({path:k,validatorName:o,
validatorProperties:p})}f.push({receiverId:d.id,path:a.binding,signal:["value","error"]})}i=0;for(k=m.length;i<k;i+=1){o=m[i];p=a[o];if(typeof p==="string"){p=p;j={args:[]};var s=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,x=p;r=void 0;for(var B=void 0;(r=s.exec(p))!==null;)j.args.push(r[0]);r=0;for(B=j.args.length;r<B;r+=1)x=x.replace(j.args[r],"arguments["+r+"]");j.processor=new Function("return "+x+";");p=j;j=u();l.push({id:j,processorArgs:p.args,processor:p.processor,signal:o});f.push({receiverId:j,
path:p.args,signal:"value"});f.push({receiverId:d.id,senderId:j,signal:o})}}}var e={},g={validationRules:[]},h={},f=[],l=[],m=["hidden","readonly"];e.getModelMetadata=function(){return g};e.getViewMetadata=function(){return h};e.getRules=function(){return f};e.getTriggers=function(){return l};c(b.metadata);return e};C.fe=n})(function(){return this}());
