(function(C,p){function u(){y+=1;return"i"+y}function x(a,c){var e,g,h,f;e=c.split(".");f=a;g=0;for(h=e.length;g<h;g+=1){f=f[e[g]];if(f===p||f===null)return p}return f}function z(a,c,e){c=c.split(".");var g=c.length-1,h=a;for(a=0;a<g;a+=1){h=h[c[a]];if(h===p)return}h[c[g]]=e}function A(a,c){var e,g=a.length,h,f;for(e=0;e<g;e+=1)if(typeof a[e].length==="number"){h=0;for(f=a[e].length;h<f;h+=1)c(a[e][h])}else c(a[e])}function w(a,c){var e;a=a||"";for(e in c)if(c.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),c[e]);return a}var k={version:"0.0.1"},y=0,D=/^\s+/,E=/\s+$/,v={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};k.rule=function(a){function c(b,d,j){if(b)e[d]=function(i){var o,n;if(typeof b==="string")return j?b.indexOf(i)===0:b===i;if(typeof b==="object"&&b.length){o=0;for(n=b.length;o<n;o+=1)if(j?b[o].indexOf(i)===0:b[o]===i)return true;return false}return true}}var e={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],f=[false,true,false],m,l;e.receiverId=a.receiverId;e.path=a.path;m=0;for(l=g.length;m<l;m+=1)c(a[g[m]],
h[m],f[m]);e.transformData=function(b,d){var j;if(b!==p&&typeof d==="string"&&typeof a.path==="string"&&a.path.length>d.length){j=d.length;return x(b,a.path.slice(j>0?j+1:j))}return b};return e};k.trigger=function(a){var c={},e=a.id,g=a.engine,h=a.processor,f=a.processorArgs,m=a.signal;c.receiveMessage=function(){var l=[],b,d=f.length;for(b=0;b<d;b+=1)l.push(g.get(f[b]));l=h.apply(p,l);g.sendMessage({senderId:e,signal:m,data:l})};g.addReceiver(e,c);return c};k.engine=function(){function a(b,d){if(typeof b!==
"string")throw Error(v.receiverIdMustBeString);if(!d||typeof d!=="function"&&typeof d.receiveMessage!=="function")throw Error(v.noReceiveMessageMethod);if(b in h)throw Error(v.notUniqueReceiverId);h[b]=typeof d!=="function"?d:{receiveMessage:d}}function c(b){if(typeof b.receiverId!=="string")throw Error(v.noReceiverId);f.push(k.rule(b))}function e(b){b.engine=g;m.push(k.trigger(b))}var g={},h={},f=[],m=[],l=[];g.addReceiver=a;g.addRule=c;g.addRules=function(){A(arguments,c)};g.addTrigger=e;g.addTriggers=
function(){A(arguments,e)};g.addModel=function(b){l.push(b)};g.sendMessage=function(b){var d,j=f.length,i;for(d=0;d<j;d+=1){i=f[d];if(b.senderId!==i.receiverId)if((!i.checkSender||i.checkSender(b.senderId))&&(!i.checkPath||i.checkPath(b.path))&&(!i.checkSignal||i.checkSignal(b.signal))){if(!(i.receiverId in h))throw Error(v.receiverNotFound);h[i.receiverId].receiveMessage({senderId:b.senderId,path:b.path,rulePath:i.path,signal:b.signal,data:i.transformData(b.data,b.path)})}}};g.get=function(b){var d,
j,i;d=0;for(j=l.length;d<j;d+=1){i=l[d].get(b);if(i!==p)return i}return p};g.subscribe=function(b,d){var j=u();a(j,d);b.receiverId=j;c(b)};return g};k.validationRule=function(a){var c={},e=a.id||u(),g=a.engine,h=a.path,f=k.validators[a.validatorName],m=a.validatorProperties||{},l={};c.receiveMessage=function(b){l[b.signal]=b.data};c.validate=function(b){if(l.hidden||l.readonly)return p;b=x(b,h);return f(b,m)};c.path=h;g.addReceiver(e,c);return c};k.model=function(a){function c(b,d){var j,i,o,n,r,
q={},s=true;if(typeof b!=="string")b="";j=0;for(i=l.length;j<i;j+=1){o=l[j];if(!(b&&o.path.indexOf(b)!==0)){q.hasOwnProperty(o.path)||(q[o.path]=[]);n=o.validate(m);if(n!==p){q[o.path].push(n);s=false}}}if(!d)for(r in q)q.hasOwnProperty(r)&&f.sendMessage({senderId:h,path:r,signal:"error",data:q[r]});return s}function e(b,d){f.sendMessage({senderId:h,path:b,signal:"value",data:d})}a=a||{};var g={},h=a.id||u(),f=a.engine,m={},l=[];g.receiveMessage=function(b){if(b.signal==="value"&&typeof b.path===
"string"){z(m,b.path,b.data);c(b.path)}};g.set=function(){if(arguments.length===1){m=arguments[0];e("",m)}else{var b=arguments[0],d=arguments[1];z(m,b,d);e(b,d)}};g.get=function(b){if(b===p)return m;return x(m,b)};g.validate=c;(function(){var b=(a.metadata||{}).validationRules||[],d,j=b.length,i;for(d=0;d<j;d+=1){i=b[d];l.push(k.validationRule({id:i.id,engine:f,path:i.path,validatorName:i.validatorName,validatorProperties:i.validatorProperties}))}})();f.addReceiver(h,g);f.addRule({receiverId:h,signal:"value"});
f.addModel(g);return g};k.validators={};k.validators.required=function(a,c){if(a===p||a===null||typeof a==="string"&&(a===null||a===p?"":a.toString().replace(D,"").replace(E,""))===""||typeof a==="number"&&isNaN(a))return w(c.message||k.validationMessages.required,c);return p};k.validators.minLength=function(a,c){if(a&&a.length!==p&&a.length<c.length)return w(c.message||k.validationMessages.minLenght,c);return p};k.validators.minLength.defaultProperty="length";k.validators.maxLength=function(a,c){if(a&&
a.length!==p&&a.length>c.length)return w(c.message||k.validationMessages.maxLenght,c);return p};k.validators.maxLength.defaultProperty="length";k.validators.minValue=function(a,c){if(a&&a<c.value)return w(c.message||k.validationMessages.minValue,c);return p};k.validators.minValue.defaultProperty="value";k.validators.maxValue=function(a,c){if(a&&a>c.value)return w(c.message||k.validationMessages.maxValue,c);return p};k.validators.maxValue.defaultProperty="value";k.validationMessages={required:"This field is required!",
minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};k.view=function(a){function c(l){var b=(h[l.typeName]||f)({metadata:l,engine:g}),d,j;m[b.id]=b;if(l.children&&l.children.length){d=0;for(j=l.children.length;d<j;d+=1)b.children.push(c(l.children[d]))}return b}var e={},g=a.engine,h=a.elementTypes,f=a.defaultElementType||
k.element,m={};e.element=c(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(l){return m[l]};return e};k.element=function(a){var c={},e=a.engine;a=a.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=a.id||u();c.properties=a.properties||{};c.children=[];c.initialize=function(){};c.receiveMessage=function(h){var f=g[h.signal];f&&typeof c[f]==="function"&&c[f](h.data)};c.notifyValueChange=function(h){var f=c.properties.binding;
if(typeof f==="string")e.sendMessage({senderId:c.id,path:f,signal:"value",data:h});else throw Error(v.elementWithoutBinding);};c.eachChild=function(h){var f,m;f=0;for(m=c.children.length;f<m;f+=1)h(c.children[f],f)};e.addReceiver(c.id,c);return c};k.expressionParser=function(a){for(var c={args:[]},e=[],g=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,h,f=a;(h=g.exec(a))!==null;){e.push(h[0]);c.args.push(h[1])}a=0;for(g=e.length;a<g;a+=1)f=f.replace(e[a],"arguments["+a+"]");c.processor=new Function("return "+
f+";");return c};k.metadataProvider=function(a){function c(d,j){var i,o,n,r=[];j=j||h;j.id=d.id||u();j.typeName=d.typeName;j.properties=d.properties||{};if(d.children&&d.children.length){j.children=[];i=0;for(o=d.children.length;i<o;i+=1){n={};c(d.children[i],n);j.children.push(n)}}if(typeof d.binding==="string"){j.properties.binding=d.binding;var q,s;r=d.binding;i=d.validationRules;o=[];for(q in i)if(i.hasOwnProperty(q)){n=k.validators[q];if(n===p)throw Error(v.unknownValidator+q);if(typeof i[q]===
"object")s=i[q];else if(typeof n.defaultProperty==="string"){s={};s[n.defaultProperty]=i[q]}n=u();n={id:n,path:r,validatorName:q,validatorProperties:s};o.push(n);g.validationRules.push(n)}r=o;f.push({receiverId:j.id,path:d.binding,signal:["value","error"]})}q=j;s=r;var t,B;r=0;for(i=l.length;r<i;r+=1){o=l[r];n=d[o];if(typeof n==="string"){t=b(n);n=u();m.push({id:n,processorArgs:t.args,processor:t.processor,signal:o});f.push({receiverId:n,path:t.args,signal:"value"});f.push({receiverId:q.id,senderId:n,
signal:o});t=0;for(B=s.length;t<B;t+=1)f.push({receiverId:s[t].id,senderId:n,signal:o})}}}var e={},g={validationRules:[]},h={},f=[],m=[],l=a.expressionProperties||["value","hidden","readonly"],b=a.expressionParser||k.expressionParser;e.getModelMetadata=function(){return g};e.getViewMetadata=function(){return h};e.getRules=function(){return f};e.getTriggers=function(){return m};c(a.metadata);return e};C.fe=k})(function(){return this}());
