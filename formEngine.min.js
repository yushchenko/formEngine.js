(function(A,q){function t(){v+=1;return"i"+v}function w(d,e){var a,j,g,f;a=e.split(".");f=d;j=0;for(g=a.length;j<g;j+=1){f=f[a[j]];if(f===q)return q}return f}function x(d,e,a){e=e.split(".");var j=e.length-1,g=d;for(d=0;d<j;d+=1){g=g[e[d]];if(g===q)return}g[e[j]]=a}function y(d,e){var a,j=d.length,g,f;for(a=0;a<j;a+=1)if(typeof d[a].length==="number"){g=0;for(f=d[a].length;g<f;g+=1)e(d[a][g])}else e(d[a])}var n={version:"0.0.1"},v=0,s={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",
receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage"',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined."};n.rule=function(d){function e(b,k,h){if(b)a[k]=function(p){var l,m;if(typeof b==="string")return h?b.indexOf(p)===
0:b===p;if(typeof b==="object"&&b.length){l=0;for(m=b.length;l<m;l+=1)if(h?b[l].indexOf(p)===0:b===p[l])return true;return false}return true}}var a={},j=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],f=[false,true,false],i,c;a.receiverId=d.receiverId;a.path=d.path;i=0;for(c=j.length;i<c;i+=1)e(d[j[i]],g[i],f[i]);a.transformData=function(b,k){var h;if(b!==q&&typeof k==="string"&&typeof d.path==="string"&&d.path.length>k.length){h=k.length;return w(b,d.path.slice(h>0?h+1:h))}return b};
return a};n.trigger=function(d){var e={},a=d.id,j=d.engine,g=d.processor,f=d.processorArgs,i=d.signal;e.receiveMessage=function(){var c=[],b,k=f.length;for(b=0;b<k;b+=1)c.push(j.get(f[b]));c=g.apply(q,c);j.sendMessage({senderId:a,signal:i,data:c})};j.addReceiver(a,e);return e};n.engine=function(){function d(c){if(typeof c.receiverId!=="string")throw Error(s.noReceiverId);g.push(n.rule(c))}function e(c){c.engine=a;f.push(n.trigger(c))}var a={},j={},g=[],f=[],i=[];a.addReceiver=function(c,b){if(typeof c!==
"string")throw Error(s.receiverIdMustBeString);if(!b||typeof b.receiveMessage!=="function")throw Error(s.noReceiveMessageMethod);if(c in j)throw Error(s.notUniqueReceiverId);j[c]=b};a.addRule=d;a.addRules=function(){y(arguments,d)};a.addTrigger=e;a.addTriggers=function(){y(arguments,e)};a.addModel=function(c){i.push(c)};a.sendMessage=function(c){var b,k=g.length,h;for(b=0;b<k;b+=1){h=g[b];if(c.senderId!==h.receiverId)if((!h.checkSender||h.checkSender(c.senderId))&&(!h.checkPath||h.checkPath(c.path))&&
(!h.checkSignal||h.checkSignal(c.signal))){if(!(h.receiverId in j))throw Error(s.receiverNotFound);j[h.receiverId].receiveMessage({senderId:c.senderId,path:c.path,rulePath:h.path,signal:c.signal,data:h.transformData(c.data,c.path)})}}};a.get=function(c){var b,k,h;b=0;for(k=i.length;b<k;b+=1){h=i[b].get(c);if(h!==q)return h}return q};return a};n.model=function(d){function e(i,c){g&&g.sendMessage({senderId:j,path:i,signal:"value",data:c})}d=d||{};var a={},j=d.id||t(),g=d.engine,f={};a.receiveMessage=
function(i){i.signal==="value"&&typeof i.path==="string"&&x(f,i.path,i.data)};a.set=function(){if(arguments.length===1){f=arguments[0];e("",f)}else{var i=arguments[0],c=arguments[1];x(f,i,c);e(i,c)}};a.get=function(i){if(i===q)return f;return w(f,i)};if(g){g.addReceiver(j,a);g.addRule({receiverId:j,signal:"value"});g.addModel(a)}return a};n.view=function(d){function e(c){var b=(g[c.typeName]||f)({metadata:c,engine:j}),k,h;i[b.id]=b;if(c.children&&c.children.length){k=0;for(h=c.children.length;k<h;k+=
1)b.children.push(e(c.children[k]))}return b}var a={},j=d.engine,g=d.elementTypes,f=d.defaultElementType||n.element,i={};a.element=e(d.metadata);a.initialize=function(){a.element.initialize()};a.getElementById=function(c){return i[c]};return a};n.element=function(d){var e={},a=d.engine;d=d.metadata||{};var j={value:"setValue",hidden:"setHidden",readonly:"setReadonly"};e.id=d.id||t();e.properties=d.properties||{};e.children=[];e.initialize=function(){};e.receiveMessage=function(g){var f=j[g.signal];
f&&typeof e[f]==="function"&&e[f](g.data)};e.notifyValueChange=function(g){var f=e.properties.binding;if(typeof f==="string")a.sendMessage({senderId:e.id,path:f,signal:"value",data:g});else throw Error(s.elementWithoutBinding);};e.eachChild=function(g){var f,i;f=0;for(i=e.children.length;f<i;f+=1)g(e.children[f],f)};a.addReceiver(e.id,e);return e};n.metadataProvider=function(d){function e(b,k){var h,p,l,m,o;k=k||g;k.id=b.id||t();k.typeName=b.typeName;k.properties=b.properties||{};if(b.children&&b.children.length){k.children=
[];h=0;for(p=b.children.length;h<p;h+=1){l={};e(b.children[h],l);k.children.push(l)}}if(typeof b.binding==="string"){f.push({receiverId:k.id,path:b.binding,signal:"value"});k.properties.binding=b.binding}h=0;for(p=c.length;h<p;h+=1){l=c[h];m=b[l];if(typeof m==="string"){m=m;o={args:[]};var B=/[a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+/g,r=void 0,u=m;r=void 0;for(var z=void 0;(r=B.exec(m))!==null;)o.args.push(r[0]);r=0;for(z=o.args.length;r<z;r+=1)u=u.replace(o.args[r],"arguments["+r+"]");o.processor=
new Function("return "+u+";");m=o;o=t();i.push({id:o,processorArgs:m.args,processor:m.processor,signal:l});f.push({receiverId:o,path:m.args,signal:"value"});f.push({receiverId:k.id,senderId:o,signal:l})}}}var a={},j=[],g={},f=[],i=[],c=["hidden","readonly"];a.getModelMetadata=function(){return j};a.getViewMetadata=function(){return g};a.getRules=function(){return f};a.getTriggers=function(){return i};e(d.metadata);return a};A.fe=n})(function(){return this}());
