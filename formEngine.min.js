(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var f,b,i,k;f=d.split(".");k=a;b=0;for(i=f.length;b<i;b+=1){k=k[f[b]];if(k===n||k===null)return n}return k}function A(a,d,f){d=d.split(".");var b=d.length-1,i=a;for(a=0;a<b;a+=1){i=i[d[a]];if(i===n)return}i[d[b]]=f}function B(a,d){var f,b=a.length,i,k;for(f=0;f<b;f+=1)if(typeof a[f].length==="number"){i=0;for(k=a[f].length;i<k;i+=1)d(a[f][i])}else d(a[f])}function w(a,d){var f;a=a||"";for(f in d)if(d.hasOwnProperty(f))a=a.replace(RegExp("{"+
f+"}","g"),d[f]);return a}var m={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};m.rule=function(a){function d(c,e,l){if(c)f[e]=function(g){var o,q;if(typeof c==="string")return l?c.indexOf(g)===0:c===g;if(typeof c==="object"&&c.length){o=0;for(q=c.length;o<q;o+=1)if(l?c[o].indexOf(g)===0:c[o]===g)return true;return false}return true}}var f={},b=["senderId","path","signal"],i=["checkSender","checkPath","checkSignal"],k=[false,true,false],j,h;f.receiverId=a.receiverId;f.path=a.path;j=0;for(h=b.length;j<h;j+=1)d(a[b[j]],
i[j],k[j]);f.transformData=function(c,e){var l;if(c!==n&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){l=e.length;return y(c,a.path.slice(l>0?l+1:l))}return c};return f};m.trigger=function(a){var d={},f=a.id,b=a.engine,i=a.processor,k=a.processorArgs,j=a.signal;d.receiveMessage=function(){var h=[],c,e=k.length;for(c=0;c<e;c+=1)h.push(b.get(k[c]));h=i.apply(n,h);b.sendMessage({senderId:f,signal:j,data:h})};b.addReceiver(f,d);return d};m.engine=function(){function a(c,e){if(typeof c!==
"string")throw Error(u.receiverIdMustBeString);if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(c in i)throw Error(u.notUniqueReceiverId);i[c]=typeof e!=="function"?e:{receiveMessage:e}}function d(c){if(typeof c.receiverId!=="string")throw Error(u.noReceiverId);k.push(m.rule(c))}function f(c){c.engine=b;j.push(m.trigger(c))}var b={},i={},k=[],j=[],h=[];b.addReceiver=a;b.addRule=d;b.addRules=function(){B(arguments,d)};b.addTrigger=f;b.addTriggers=
function(){B(arguments,f)};b.addModel=function(c){h.push(c)};b.sendMessage=function(c){var e,l=k.length,g;for(e=0;e<l;e+=1){g=k[e];if(c.senderId!==g.receiverId)if((!g.checkSender||g.checkSender(c.senderId))&&(!g.checkPath||g.checkPath(c.path))&&(!g.checkSignal||g.checkSignal(c.signal))){if(!(g.receiverId in i))throw Error(u.receiverNotFound);i[g.receiverId].receiveMessage({senderId:c.senderId,path:c.path,rulePath:g.path,signal:c.signal,data:g.transformData(c.data,c.path)})}}};b.get=function(c){var e,
l,g;e=0;for(l=h.length;e<l;e+=1){g=h[e].get(c);if(g!==n)return g}return n};b.subscribe=function(c,e){var l=t();a(l,e);c.receiverId=l;d(c)};return b};m.validationRule=function(a){var d={},f=a.id||t(),b=a.engine,i=a.path,k=m.validators[a.validatorName],j=a.validatorProperties||{},h;d.receiveMessage=function(c){if(c.signal==="validation-inactive")h=c.data};d.validate=function(c){if(h)return n;c=y(c,i);return k(c,j)};d.path=i;b.addReceiver(f,d);return d};m.model=function(a){function d(c,e){var l,g,o,
q,s,p={},r=true;if(typeof c!=="string")c="";l=0;for(g=h.length;l<g;l+=1){o=h[l];if(!(c&&o.path.indexOf(c)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(j);if(q!==n){p[o.path].push(q);r=false}}}if(!e)for(s in p)p.hasOwnProperty(s)&&k.sendMessage({senderId:i,path:s,signal:"error",data:p[s]});return r}function f(c,e){k.sendMessage({senderId:i,path:c,signal:"value",data:e})}a=a||{};var b={},i=a.id||t(),k=a.engine,j={},h=[];b.receiveMessage=function(c){if(c.signal==="value"&&typeof c.path===
"string"){A(j,c.path,c.data);d(c.path)}};b.set=function(){if(arguments.length===1){j=arguments[0];f("",j)}else{var c=arguments[0],e=arguments[1];A(j,c,e);f(c,e)}};b.get=function(c){if(c===n)return j;return y(j,c)};b.validate=d;(function(){var c=(a.metadata||{}).validationRules||[],e,l=c.length,g;for(e=0;e<l;e+=1){g=c[e];h.push(m.validationRule({id:g.id,engine:k,path:g.path,validatorName:g.validatorName,validatorProperties:g.validatorProperties}))}})();k.addReceiver(i,b);k.addRule({receiverId:i,signal:"value"});
k.addModel(b);return b};m.validators={};m.validators.required=function(a,d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||m.validationMessages.required,d);return n};m.validators.minLength=function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||m.validationMessages.minLenght,d);return n};m.validators.minLength.defaultProperty="length";m.validators.maxLength=function(a,d){if(a&&
a.length!==n&&a.length>d.length)return w(d.message||m.validationMessages.maxLenght,d);return n};m.validators.maxLength.defaultProperty="length";m.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||m.validationMessages.minValue,d);return n};m.validators.minValue.defaultProperty="value";m.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||m.validationMessages.maxValue,d);return n};m.validators.maxValue.defaultProperty="value";m.validationMessages={required:"This field is required!",
minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};m.view=function(a){function d(h){var c=(i[h.typeName]||k)({metadata:h,engine:b}),e,l;j[c.id]=c;if(h.children&&h.children.length){e=0;for(l=h.children.length;e<l;e+=1)c.addElement(d(h.children[e]))}return c}var f={},b=a.engine,i=a.elementTypes,k=a.defaultElementType||
m.element,j={};f.element=d(a.metadata);f.initialize=function(){f.element.initialize()};f.getElementById=function(h){return j[h]};return f};m.element=function(a){function d(){i.sendMessage({senderId:b.id,signal:"validation-inactive",data:b.isHidden()||b.isReadonly()});f(function(j){j.notifyValidationStatusChange()})}function f(j){var h,c;h=0;for(c=b.children.length;h<c;h+=1)j(b.children[h],h)}var b={},i=a.engine;a=a.metadata||{};var k={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};
b.id=a.id||t();b.properties=a.properties||{};b.children=[];b.parent=n;b.initialize=function(){};b.addElement=function(j){b.children.push(j);j.parent=b};b.receiveMessage=function(j){var h=k[j.signal];h&&typeof b[h]==="function"&&b[h](j.data)};b.setValue=void 0;b.notifyValueChange=function(j){var h=b.properties.binding;if(typeof h==="string")i.sendMessage({senderId:b.id,path:h,signal:"value",data:j});else throw Error(u.elementWithoutBinding);};b.setHidden=function(j){b.hidden=j;d()};b.setReadonly=function(j){b.readonly=
j;d()};b.isHidden=function(){return!!b.hidden||b.parent&&b.parent.isHidden()};b.isReadonly=function(){return!!b.readonly};b.notifyValidationStatusChange=d;b.showErrors=function(){};b.eachChild=f;i.addReceiver(b.id,b);return b};m.expressionParser=function(a){for(var d={args:[]},f=[],b=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,i,k=a;(i=b.exec(a))!==null;){f.push(i[0]);d.args.push(i[1])}a=0;for(b=f.length;a<b;a+=1)k=k.replace(f[a],"arguments["+a+"]");d.processor=new Function("return "+k+";");
return d};m.metadataProvider=function(a){function d(e,l){var g,o,q;l=l||i;l.id=e.id||t();l.typeName=e.typeName;l.properties=e.properties||{};q=l;var s,p,r,v,x,C;s=0;for(p=h.length;s<p;s+=1){r=h[s];v=e[r];if(typeof v==="string"){v=c(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};j.push(C);k.push({receiverId:x,path:v.args,signal:"value"});k.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof e.binding==="string"){l.properties.binding=e.binding;q=l;s=e.binding;p=e.validationRules||
{};for(g in p)if(p.hasOwnProperty(g)){r=m.validators[g];if(r===n)throw Error(u.unknownValidator+g);if(typeof p[g]==="object")o=p[g];else if(typeof r.defaultProperty==="string"){o={};o[r.defaultProperty]=p[g]}r=t();b.validationRules.push({id:r,path:s,validatorName:g,validatorProperties:o});k.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}k.push({receiverId:l.id,path:e.binding,signal:["value","error"]})}if(e.children&&e.children.length){l.children=[];g=0;for(o=e.children.length;g<o;g+=
1){q={};d(e.children[g],q,l);l.children.push(q)}}}var f={},b={validationRules:[]},i={},k=[],j=[],h=a.expressionProperties||["value","hidden","readonly"],c=a.expressionParser||m.expressionParser;f.getModelMetadata=function(){return b};f.getViewMetadata=function(){return i};f.getRules=function(){return k};f.getTriggers=function(){return j};d(a.metadata);return f};D.fe=m})(function(){return this}());
