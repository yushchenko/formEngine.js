(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var f,c,h,i;f=d.split(".");i=a;c=0;for(h=f.length;c<h;c+=1){i=i[f[c]];if(i===n||i===null)return n}return i}function A(a,d,f){d=d.split(".");var c=d.length-1,h=a;for(a=0;a<c;a+=1){h=h[d[a]];if(h===n)return}h[d[c]]=f}function B(a,d){var f,c=a.length,h,i;for(f=0;f<c;f+=1)if(typeof a[f].length==="number"){h=0;for(i=a[f].length;h<i;h+=1)d(a[f][h])}else d(a[f])}function w(a,d){var f;a=a||"";for(f in d)if(d.hasOwnProperty(f))a=a.replace(RegExp("{"+
f+"}","g"),d[f]);return a}var l={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};l.dsl={};l.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,d){this.element.properties[a]=d;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};l.dsl.elementConstructor=function(a,d,f){function c(h,i,j){function g(e,m){h[e]=function(){return m.apply(j,arguments)}}for(var b in i)i.hasOwnProperty(b)&&g(b,i[b])}d=d||{};d.defaultProperty=d.defaultProperty||"binding";f=f||{};return function(){function h(){var g,b=arguments.length,e;for(g=0;g<b;g+=1){e=arguments[g];if(typeof e==="function"&&typeof e.get===
"function")i.elements.push(e.get());else if(g===0&&typeof d.defaultProperty==="string")i[d.defaultProperty]=e}return h}var i={typeName:a,properties:{},validationRules:{},elements:[]},j={element:i,chain:h,params:d};typeof d.initialize==="function"&&d.initialize.apply(j);c(h,l.dsl.defaultElementProperties,j);c(h,f,j);return h.apply(n,arguments)}};l.rule=function(a){function d(b,e,m){if(b)f[e]=function(k){var o,q;if(typeof b==="string")return m?b.indexOf(k)===0:b===k;if(typeof b==="object"&&b.length){o=
0;for(q=b.length;o<q;o+=1)if(m?b[o].indexOf(k)===0:b[o]===k)return true;return false}return true}}var f={},c=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],i=[false,true,false],j,g;f.receiverId=a.receiverId;f.path=a.path;j=0;for(g=c.length;j<g;j+=1)d(a[c[j]],h[j],i[j]);f.transformData=function(b,e){var m;if(b!==n&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){m=e.length;return y(b,a.path.slice(m>0?m+1:m))}return b};return f};l.trigger=function(a){var d=
{},f=a.id,c=a.engine,h=a.processor,i=a.processorArgs,j=a.signal;d.receiveMessage=function(){var g=[],b,e=i.length;for(b=0;b<e;b+=1)g.push(c.get(i[b]));g=h.apply(n,g);c.sendMessage({senderId:f,signal:j,data:g})};c.addReceiver(f,d);return d};l.engine=function(){function a(b,e){if(typeof b!=="string")throw Error(u.receiverIdMustBeString);if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(b in h)throw Error(u.notUniqueReceiverId);h[b]=typeof e!==
"function"?e:{receiveMessage:e}}function d(b){if(typeof b.receiverId!=="string")throw Error(u.noReceiverId);i.push(l.rule(b))}function f(b){b.engine=c;j.push(l.trigger(b))}var c={},h={},i=[],j=[],g=[];c.addReceiver=a;c.addRule=d;c.addRules=function(){B(arguments,d)};c.addTrigger=f;c.addTriggers=function(){B(arguments,f)};c.addModel=function(b){g.push(b)};c.sendMessage=function(b){var e,m=i.length,k;for(e=0;e<m;e+=1){k=i[e];if(b.senderId!==k.receiverId)if((!k.checkSender||k.checkSender(b.senderId))&&
(!k.checkPath||k.checkPath(b.path))&&(!k.checkSignal||k.checkSignal(b.signal))){if(!(k.receiverId in h))throw Error(u.receiverNotFound);h[k.receiverId].receiveMessage({senderId:b.senderId,path:b.path,rulePath:k.path,signal:b.signal,data:k.transformData(b.data,b.path)})}}};c.get=function(b){var e,m,k;e=0;for(m=g.length;e<m;e+=1){k=g[e].get(b);if(k!==n)return k}return n};c.subscribe=function(b,e){var m=t();a(m,e);b.receiverId=m;d(b)};return c};l.validationRule=function(a){var d={},f=a.id||t(),c=a.engine,
h=a.path,i=l.validators[a.validatorName],j=a.validatorProperties||{},g;d.receiveMessage=function(b){if(b.signal==="validation-inactive")g=b.data};d.validate=function(b){if(g)return n;b=y(b,h);return i(b,j)};d.path=h;c.addReceiver(f,d);return d};l.model=function(a){function d(b,e){var m,k,o,q,s,p={},r=true;if(typeof b!=="string")b="";m=0;for(k=g.length;m<k;m+=1){o=g[m];if(!(b&&o.path.indexOf(b)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(j);if(q!==n){p[o.path].push(q);r=false}}}if(!e)for(s in p)p.hasOwnProperty(s)&&
i.sendMessage({senderId:h,path:s,signal:"error",data:p[s]});return r}function f(b,e){i.sendMessage({senderId:h,path:b,signal:"value",data:e})}a=a||{};var c={},h=a.id||t(),i=a.engine,j={},g=[];c.receiveMessage=function(b){if(b.signal==="value"&&typeof b.path==="string"){A(j,b.path,b.data);d(b.path)}};c.set=function(){if(arguments.length===1){j=arguments[0];f("",j)}else{var b=arguments[0],e=arguments[1];A(j,b,e);f(b,e)}};c.get=function(b){if(b===n)return j;return y(j,b)};c.validate=d;(function(){var b=
(a.metadata||{}).validationRules||[],e,m=b.length,k;for(e=0;e<m;e+=1){k=b[e];g.push(l.validationRule({id:k.id,engine:i,path:k.path,validatorName:k.validatorName,validatorProperties:k.validatorProperties}))}})();i.addReceiver(h,c);i.addRule({receiverId:h,signal:"value"});i.addModel(c);return c};l.validators={};l.validators.required=function(a,d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||
l.validationMessages.required,d);return n};l.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};l.validators.minLength=function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||l.validationMessages.minLenght,d);return n};l.validators.minLength.defaultProperty="length";l.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};l.validators.maxLength=function(a,d){if(a&&
a.length!==n&&a.length>d.length)return w(d.message||l.validationMessages.maxLenght,d);return n};l.validators.maxLength.defaultProperty="length";l.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};l.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||l.validationMessages.minValue,d);return n};l.validators.minValue.defaultProperty="value";l.dsl.defaultElementProperties.minValue=function(a){this.element.validationRules.minValue=
a;return this.chain};l.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||l.validationMessages.maxValue,d);return n};l.validators.maxValue.defaultProperty="value";l.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};l.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",
maxValue:"This field should have value less that {value}!"};l.view=function(a){function d(g){var b=(h[g.typeName]||i)({metadata:g,engine:c}),e,m;j[b.id]=b;if(g.elements&&g.elements.length){e=0;for(m=g.elements.length;e<m;e+=1)b.addElement(d(g.elements[e]))}return b}var f={},c=a.engine,h=a.elementTypes,i=a.defaultElementType||l.element,j={};f.element=d(a.metadata);f.initialize=function(){f.element.initialize()};f.getElementById=function(g){return j[g]};return f};l.element=function(a){function d(){h.sendMessage({senderId:c.id,
signal:"validation-inactive",data:c.isHidden()||c.isReadonly()});f(function(j){j.notifyValidationStatusChange()})}function f(j){var g,b;g=0;for(b=c.elements.length;g<b;g+=1)j(c.elements[g],g)}var c={},h=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};c.id=a.id||t();c.properties=a.properties||{};c.elements=[];c.parent=n;c.initialize=function(){};c.addElement=function(j){c.elements.push(j);j.parent=c};c.receiveMessage=function(j){var g=
i[j.signal];g&&typeof c[g]==="function"&&c[g](j.data)};c.setValue=void 0;c.notifyValueChange=function(j){var g=c.properties.binding;if(typeof g==="string")h.sendMessage({senderId:c.id,path:g,signal:"value",data:j});else throw Error(u.elementWithoutBinding);};c.setHidden=function(j){c.hidden=j;d()};c.setReadonly=function(j){c.readonly=j;d()};c.isHidden=function(){return!!c.hidden||c.parent&&c.parent.isHidden()};c.isReadonly=function(){return!!c.readonly};c.notifyValidationStatusChange=d;c.showErrors=
function(){};c.eachChild=f;h.addReceiver(c.id,c);return c};l.expressionParser=function(a){for(var d={args:[]},f=[],c=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,h,i=a;(h=c.exec(a))!==null;){f.push(h[0]);d.args.push(h[1])}a=0;for(c=f.length;a<c;a+=1)i=i.replace(f[a],"arguments["+a+"]");d.processor=new Function("return "+i+";");return d};l.metadataProvider=function(a){function d(e,m){var k,o,q;m=m||h;m.id=e.id||t();m.typeName=e.typeName;m.properties=e.properties||{};q=m;var s,p,r,v,x,C;s=0;
for(p=g.length;s<p;s+=1){r=g[s];v=e[r];if(typeof v==="string"){v=b(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};j.push(C);i.push({receiverId:x,path:v.args,signal:"value"});i.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof e.binding==="string"){m.properties.binding=e.binding;q=m;s=e.binding;p=e.validationRules||{};for(k in p)if(p.hasOwnProperty(k)){r=l.validators[k];if(r===n)throw Error(u.unknownValidator+k);if(typeof p[k]==="object")o=p[k];else if(typeof r.defaultProperty===
"string"){o={};o[r.defaultProperty]=p[k]}r=t();c.validationRules.push({id:r,path:s,validatorName:k,validatorProperties:o});i.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}i.push({receiverId:m.id,path:e.binding,signal:["value","error"]})}if(e.elements&&e.elements.length){m.elements=[];k=0;for(o=e.elements.length;k<o;k+=1){q={};d(e.elements[k],q,m);m.elements.push(q)}}}var f={},c={validationRules:[]},h={},i=[],j=[],g=a.expressionProperties||["value","hidden","readonly"],b=a.expressionParser||
l.expressionParser;f.getModelMetadata=function(){return c};f.getViewMetadata=function(){return h};f.getRules=function(){return i};f.getTriggers=function(){return j};d(a.metadata);return f};D.fe=l})(function(){return this}());
