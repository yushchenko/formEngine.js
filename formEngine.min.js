(function(A,p){function u(){x+=1;return"i"+x}function w(a,b){var d,g,h,f;d=b.split(".");f=a;g=0;for(h=d.length;g<h;g+=1){f=f[d[g]];if(f===p)return p}return f}function y(a,b,d){b=b.split(".");var g=b.length-1,h=a;for(a=0;a<g;a+=1){h=h[b[a]];if(h===p)return}h[b[g]]=d}function z(a,b){var d,g=a.length,h,f;for(d=0;d<g;d+=1)if(typeof a[d].length==="number"){h=0;for(f=a[d].length;h<f;h+=1)b(a[d][h])}else b(a[d])}function v(a,b){var d;a=a||"";for(d in b)if(b.hasOwnProperty(d))a=a.replace(RegExp("{"+d+"}",
"g"),b[d]);return a}var k={version:"0.0.1"},x=0,B=/^\s+/,C=/\s+$/,s={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};k.rule=function(a){function b(c,e,j){if(c)d[e]=function(i){var n,o;if(typeof c==="string")return j?c.indexOf(i)===0:c===i;if(typeof c==="object"&&c.length){n=0;for(o=c.length;n<o;n+=1)if(j?c[n].indexOf(i)===0:c[n]===i)return true;return false}return true}}var d={},g=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],f=[false,true,false],l,m;d.receiverId=a.receiverId;d.path=a.path;l=0;for(m=g.length;l<m;l+=1)b(a[g[l]],
h[l],f[l]);d.transformData=function(c,e){var j;if(c!==p&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){j=e.length;return w(c,a.path.slice(j>0?j+1:j))}return c};return d};k.trigger=function(a){var b={},d=a.id,g=a.engine,h=a.processor,f=a.processorArgs,l=a.signal;b.receiveMessage=function(){var m=[],c,e=f.length;for(c=0;c<e;c+=1)m.push(g.get(f[c]));m=h.apply(p,m);g.sendMessage({senderId:d,signal:l,data:m})};g.addReceiver(d,b);return b};k.engine=function(){function a(c,e){if(typeof c!==
"string")throw Error(s.receiverIdMustBeString);if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(s.noReceiveMessageMethod);if(c in h)throw Error(s.notUniqueReceiverId);h[c]=typeof e!=="function"?e:{receiveMessage:e}}function b(c){if(typeof c.receiverId!=="string")throw Error(s.noReceiverId);f.push(k.rule(c))}function d(c){c.engine=g;l.push(k.trigger(c))}var g={},h={},f=[],l=[],m=[];g.addReceiver=a;g.addRule=b;g.addRules=function(){z(arguments,b)};g.addTrigger=d;g.addTriggers=
function(){z(arguments,d)};g.addModel=function(c){m.push(c)};g.sendMessage=function(c){var e,j=f.length,i;for(e=0;e<j;e+=1){i=f[e];if(c.senderId!==i.receiverId)if((!i.checkSender||i.checkSender(c.senderId))&&(!i.checkPath||i.checkPath(c.path))&&(!i.checkSignal||i.checkSignal(c.signal))){if(!(i.receiverId in h))throw Error(s.receiverNotFound);h[i.receiverId].receiveMessage({senderId:c.senderId,path:c.path,rulePath:i.path,signal:c.signal,data:i.transformData(c.data,c.path)})}}};g.get=function(c){var e,
j,i;e=0;for(j=m.length;e<j;e+=1){i=m[e].get(c);if(i!==p)return i}return p};g.subscribe=function(c,e){var j=u();a(j,e);c.receiverId=j;b(c)};return g};k.model=function(a){function b(c,e){var j,i,n,o,q,r={},t=true;if(typeof c!=="string")c="";j=0;for(i=m.length;j<i;j+=1){n=m[j];if(!(c&&n.path.indexOf(c)!==0)){r.hasOwnProperty(n.path)||(r[n.path]=[]);o=k.validators[n.validatorName];o=o(w(l,n.path),n.validatorProperties||{});if(o!==p){r[n.path].push(o);t=false}}}if(!e)for(q in r)r.hasOwnProperty(q)&&f.sendMessage({senderId:h,
path:q,signal:"error",data:r[q]});return t}function d(c,e){f.sendMessage({senderId:h,path:c,signal:"value",data:e})}a=a||{};var g={},h=a.id||u(),f=a.engine,l={},m=(a.metadata||{}).validationRules||[];g.receiveMessage=function(c){if(c.signal==="value"&&typeof c.path==="string"){y(l,c.path,c.data);b(c.path)}};g.set=function(){if(arguments.length===1){l=arguments[0];d("",l)}else{var c=arguments[0],e=arguments[1];y(l,c,e);d(c,e)}};g.get=function(c){if(c===p)return l;return w(l,c)};g.validate=b;if(f){f.addReceiver(h,
g);f.addRule({receiverId:h,signal:"value"});f.addModel(g)}return g};k.validators={};k.validators.required=function(a,b){if(a===p||a===null||typeof a==="string"&&(a===null||a===p?"":a.toString().replace(B,"").replace(C,""))===""||typeof a==="number"&&isNaN(a))return v(b.message||k.validationMessages.required,b);return p};k.validators.minLength=function(a,b){if(a&&a.length!==p&&a.length<b.length)return v(b.message||k.validationMessages.minLenght,b);return p};k.validators.minLength.defaultProperty="length";
k.validators.maxLength=function(a,b){if(a&&a.length!==p&&a.length>b.length)return v(b.message||k.validationMessages.maxLenght,b);return p};k.validators.maxLength.defaultProperty="length";k.validators.minValue=function(a,b){if(a&&a<b.value)return v(b.message||k.validationMessages.minValue,b);return p};k.validators.minValue.defaultProperty="value";k.validators.maxValue=function(a,b){if(a&&a>b.value)return v(b.message||k.validationMessages.maxValue,b);return p};k.validators.maxValue.defaultProperty=
"value";k.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};k.view=function(a){function b(m){var c=(h[m.typeName]||f)({metadata:m,engine:g}),e,j;l[c.id]=c;if(m.children&&m.children.length){e=0;for(j=m.children.length;e<j;e+=1)c.children.push(b(m.children[e]))}return c}
var d={},g=a.engine,h=a.elementTypes,f=a.defaultElementType||k.element,l={};d.element=b(a.metadata);d.initialize=function(){d.element.initialize()};d.getElementById=function(m){return l[m]};return d};k.element=function(a){var b={},d=a.engine;a=a.metadata||{};var g={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};b.id=a.id||u();b.properties=a.properties||{};b.children=[];b.initialize=function(){};b.receiveMessage=function(h){var f=g[h.signal];f&&typeof b[f]==="function"&&
b[f](h.data)};b.notifyValueChange=function(h){var f=b.properties.binding;if(typeof f==="string")d.sendMessage({senderId:b.id,path:f,signal:"value",data:h});else throw Error(s.elementWithoutBinding);};b.eachChild=function(h){var f,l;f=0;for(l=b.children.length;f<l;f+=1)h(b.children[f],f)};d.addReceiver(b.id,b);return b};k.expressionParser=function(a){for(var b={args:[]},d=[],g=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,h,f=a;(h=g.exec(a))!==null;){d.push(h[0]);b.args.push(h[1])}a=0;for(g=
d.length;a<g;a+=1)f=f.replace(d[a],"arguments["+a+"]");b.processor=new Function("return "+f+";");return b};k.metadataProvider=function(a){function b(e,j){var i,n,o;j=j||h;j.id=e.id||u();j.typeName=e.typeName;j.properties=e.properties||{};if(e.children&&e.children.length){j.children=[];i=0;for(n=e.children.length;i<n;i+=1){o={};b(e.children[i],o);j.children.push(o)}}if(typeof e.binding==="string"){j.properties.binding=e.binding;i=e.validationRules||{};n=e.binding;var q,r;for(q in i)if(i.hasOwnProperty(q)){o=
k.validators[q];if(o===p)throw Error(s.unknownValidator+q);if(typeof i[q]==="object")r=i[q];else if(typeof o.defaultProperty==="string"){r={};r[o.defaultProperty]=i[q]}g.validationRules.push({path:n,validatorName:q,validatorProperties:r})}f.push({receiverId:j.id,path:e.binding,signal:["value","error"]})}q=j;var t;r=0;for(i=m.length;r<i;r+=1){n=m[r];o=e[n];if(typeof o==="string"){o=c(o);t=u();l.push({id:t,processorArgs:o.args,processor:o.processor,signal:n});f.push({receiverId:t,path:o.args,signal:"value"});
f.push({receiverId:q.id,senderId:t,signal:n})}}}var d={},g={validationRules:[]},h={},f=[],l=[],m=a.expressionProperties||["value","hidden","readonly"],c=a.expressionParser||k.expressionParser;d.getModelMetadata=function(){return g};d.getViewMetadata=function(){return h};d.getRules=function(){return f};d.getTriggers=function(){return l};b(a.metadata);return d};A.fe=k})(function(){return this}());
