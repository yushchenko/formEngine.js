(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var f,c,i,k;f=d.split(".");k=a;c=0;for(i=f.length;c<i;c+=1){k=k[f[c]];if(k===n||k===null)return n}return k}function A(a,d,f){d=d.split(".");var c=d.length-1,i=a;for(a=0;a<c;a+=1){i=i[d[a]];if(i===n)return}i[d[c]]=f}function B(a,d){var f,c=a.length,i,k;for(f=0;f<c;f+=1)if(typeof a[f].length==="number"){i=0;for(k=a[f].length;i<k;i+=1)d(a[f][i])}else d(a[f])}function w(a,d){var f;a=a||"";for(f in d)if(d.hasOwnProperty(f))a=a.replace(RegExp("{"+
f+"}","g"),d[f]);return a}var m={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};m.rule=function(a){function d(b,e,l){if(b)f[e]=function(g){var o,q;if(typeof b==="string")return l?b.indexOf(g)===0:b===g;if(typeof b==="object"&&b.length){o=0;for(q=b.length;o<q;o+=1)if(l?b[o].indexOf(g)===0:b[o]===g)return true;return false}return true}}var f={},c=["senderId","path","signal"],i=["checkSender","checkPath","checkSignal"],k=[false,true,false],j,h;f.receiverId=a.receiverId;f.path=a.path;j=0;for(h=c.length;j<h;j+=1)d(a[c[j]],
i[j],k[j]);f.transformData=function(b,e){var l;if(b!==n&&typeof e==="string"&&typeof a.path==="string"&&a.path.length>e.length){l=e.length;return y(b,a.path.slice(l>0?l+1:l))}return b};return f};m.trigger=function(a){var d={},f=a.id,c=a.engine,i=a.processor,k=a.processorArgs,j=a.signal;d.receiveMessage=function(){var h=[],b,e=k.length;for(b=0;b<e;b+=1)h.push(c.get(k[b]));h=i.apply(n,h);c.sendMessage({senderId:f,signal:j,data:h})};c.addReceiver(f,d);return d};m.engine=function(){function a(b,e){if(typeof b!==
"string")throw Error(u.receiverIdMustBeString);if(!e||typeof e!=="function"&&typeof e.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(b in i)throw Error(u.notUniqueReceiverId);i[b]=typeof e!=="function"?e:{receiveMessage:e}}function d(b){if(typeof b.receiverId!=="string")throw Error(u.noReceiverId);k.push(m.rule(b))}function f(b){b.engine=c;j.push(m.trigger(b))}var c={},i={},k=[],j=[],h=[];c.addReceiver=a;c.addRule=d;c.addRules=function(){B(arguments,d)};c.addTrigger=f;c.addTriggers=
function(){B(arguments,f)};c.addModel=function(b){h.push(b)};c.sendMessage=function(b){var e,l=k.length,g;for(e=0;e<l;e+=1){g=k[e];if(b.senderId!==g.receiverId)if((!g.checkSender||g.checkSender(b.senderId))&&(!g.checkPath||g.checkPath(b.path))&&(!g.checkSignal||g.checkSignal(b.signal))){if(!(g.receiverId in i))throw Error(u.receiverNotFound);i[g.receiverId].receiveMessage({senderId:b.senderId,path:b.path,rulePath:g.path,signal:b.signal,data:g.transformData(b.data,b.path)})}}};c.get=function(b){var e,
l,g;e=0;for(l=h.length;e<l;e+=1){g=h[e].get(b);if(g!==n)return g}return n};c.subscribe=function(b,e){var l=t();a(l,e);b.receiverId=l;d(b)};return c};m.validationRule=function(a){var d={},f=a.id||t(),c=a.engine,i=a.path,k=m.validators[a.validatorName],j=a.validatorProperties||{},h;d.receiveMessage=function(b){if(b.signal==="validation-inactive")h=b.data};d.validate=function(b){if(h)return n;b=y(b,i);return k(b,j)};d.path=i;c.addReceiver(f,d);return d};m.model=function(a){function d(b,e){var l,g,o,
q,s,p={},r=true;if(typeof b!=="string")b="";l=0;for(g=h.length;l<g;l+=1){o=h[l];if(!(b&&o.path.indexOf(b)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(j);if(q!==n){p[o.path].push(q);r=false}}}if(!e)for(s in p)p.hasOwnProperty(s)&&k.sendMessage({senderId:i,path:s,signal:"error",data:p[s]});return r}function f(b,e){k.sendMessage({senderId:i,path:b,signal:"value",data:e})}a=a||{};var c={},i=a.id||t(),k=a.engine,j={},h=[];c.receiveMessage=function(b){if(b.signal==="value"&&typeof b.path===
"string"){A(j,b.path,b.data);d(b.path)}};c.set=function(){if(arguments.length===1){j=arguments[0];f("",j)}else{var b=arguments[0],e=arguments[1];A(j,b,e);f(b,e)}};c.get=function(b){if(b===n)return j;return y(j,b)};c.validate=d;(function(){var b=(a.metadata||{}).validationRules||[],e,l=b.length,g;for(e=0;e<l;e+=1){g=b[e];h.push(m.validationRule({id:g.id,engine:k,path:g.path,validatorName:g.validatorName,validatorProperties:g.validatorProperties}))}})();k.addReceiver(i,c);k.addRule({receiverId:i,signal:"value"});
k.addModel(c);return c};m.validators={};m.validators.required=function(a,d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||m.validationMessages.required,d);return n};m.validators.minLength=function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||m.validationMessages.minLenght,d);return n};m.validators.minLength.defaultProperty="length";m.validators.maxLength=function(a,d){if(a&&
a.length!==n&&a.length>d.length)return w(d.message||m.validationMessages.maxLenght,d);return n};m.validators.maxLength.defaultProperty="length";m.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||m.validationMessages.minValue,d);return n};m.validators.minValue.defaultProperty="value";m.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||m.validationMessages.maxValue,d);return n};m.validators.maxValue.defaultProperty="value";m.validationMessages={required:"This field is required!",
minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};m.view=function(a){function d(h){var b=(i[h.typeName]||k)({metadata:h,engine:c}),e,l;j[b.id]=b;if(h.children&&h.children.length){e=0;for(l=h.children.length;e<l;e+=1)b.addElement(d(h.children[e]))}return b}var f={},c=a.engine,i=a.elementTypes,k=a.defaultElementType||
m.element,j={};f.element=d(a.metadata);f.initialize=function(){f.element.initialize()};f.getElementById=function(h){return j[h]};return f};m.element=function(a){function d(){i.sendMessage({senderId:c.id,signal:"validation-inactive",data:c.isHidden()||c.isReadonly()});f(function(j){j.notifyValidationStatusChange()})}function f(j){var h,b;h=0;for(b=c.children.length;h<b;h+=1)j(c.children[h],h)}var c={},i=a.engine;a=a.metadata||{};var k={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};
c.id=a.id||t();c.properties=a.properties||{};c.children=[];c.parent=n;c.initialize=function(){};c.addElement=function(j){c.children.push(j);j.parent=c};c.receiveMessage=function(j){var h=k[j.signal];h&&typeof c[h]==="function"&&c[h](j.data)};c.notifyValueChange=function(j){var h=c.properties.binding;if(typeof h==="string")i.sendMessage({senderId:c.id,path:h,signal:"value",data:j});else throw Error(u.elementWithoutBinding);};c.setHidden=function(j){c.hidden=j;d()};c.setReadonly=function(j){c.readonly=
j;d()};c.isHidden=function(){return!!c.hidden||c.parent&&c.parent.isHidden()};c.isReadonly=function(){return!!c.readonly};c.notifyValidationStatusChange=d;c.eachChild=f;i.addReceiver(c.id,c);return c};m.expressionParser=function(a){for(var d={args:[]},f=[],c=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,i,k=a;(i=c.exec(a))!==null;){f.push(i[0]);d.args.push(i[1])}a=0;for(c=f.length;a<c;a+=1)k=k.replace(f[a],"arguments["+a+"]");d.processor=new Function("return "+k+";");return d};m.metadataProvider=
function(a){function d(e,l){var g,o,q;l=l||i;l.id=e.id||t();l.typeName=e.typeName;l.properties=e.properties||{};q=l;var s,p,r,v,x,C;s=0;for(p=h.length;s<p;s+=1){r=h[s];v=e[r];if(typeof v==="string"){v=b(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};j.push(C);k.push({receiverId:x,path:v.args,signal:"value"});k.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof e.binding==="string"){l.properties.binding=e.binding;q=l;s=e.binding;p=e.validationRules||{};for(g in p)if(p.hasOwnProperty(g)){r=
m.validators[g];if(r===n)throw Error(u.unknownValidator+g);if(typeof p[g]==="object")o=p[g];else if(typeof r.defaultProperty==="string"){o={};o[r.defaultProperty]=p[g]}r=t();c.validationRules.push({id:r,path:s,validatorName:g,validatorProperties:o});k.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}k.push({receiverId:l.id,path:e.binding,signal:["value","error"]})}if(e.children&&e.children.length){l.children=[];g=0;for(o=e.children.length;g<o;g+=1){q={};d(e.children[g],q,l);l.children.push(q)}}}
var f={},c={validationRules:[]},i={},k=[],j=[],h=a.expressionProperties||["value","hidden","readonly"],b=a.expressionParser||m.expressionParser;f.getModelMetadata=function(){return c};f.getViewMetadata=function(){return i};f.getRules=function(){return k};f.getTriggers=function(){return j};d(a.metadata);return f};D.fe=m})(function(){return this}());
