(function(D,n){function t(){z+=1;return"i"+z}function y(a,d){var e,b,h,i;e=d.split(".");i=a;b=0;for(h=e.length;b<h;b+=1){i=i[e[b]];if(i===n||i===null)return n}return i}function A(a,d,e){d=d.split(".");var b=d.length-1,h=a;for(a=0;a<b;a+=1){h=h[d[a]];if(h===n)return}h[d[b]]=e}function B(a,d){var e,b=a.length,h,i;for(e=0;e<b;e+=1)if(typeof a[e].length==="number"){h=0;for(i=a[e].length;h<i;h+=1)d(a[e][h])}else d(a[e])}function w(a,d){var e;a=a||"";for(e in d)if(d.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),d[e]);return a}var k={version:"0.0.1"},z=0,E=/^\s+/,F=/\s+$/,u={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};k.dsl={};k.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,d){this.element.properties[a]=d;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};k.dsl.elementConstructor=function(a,d,e){function b(h,i,j){function g(f,m){h[f]=function(){return m.apply(j,arguments)}}for(var c in i)i.hasOwnProperty(c)&&g(c,i[c])}d=d||{};d.defaultProperty=d.defaultProperty||"binding";e=e||{};return function(){function h(){var g,c=arguments.length,f;for(g=0;g<c;g+=1){f=arguments[g];if(typeof f==="function"&&typeof f.get===
"function")i.elements.push(f.get());else if(g===0&&typeof d.defaultProperty==="string")i[d.defaultProperty]=f}return h}var i={typeName:a,properties:{},validationRules:{},elements:[]},j={element:i,chain:h,params:d};typeof d.initialize==="function"&&d.initialize.apply(j);b(h,k.dsl.defaultElementProperties,j);b(h,e,j);return h.apply(n,arguments)}};k.rule=function(a){function d(c,f,m){if(c)e[f]=function(l){var o,q;if(typeof c==="string")return m?c.indexOf(l)===0:c===l;if(typeof c==="object"&&c.length){o=
0;for(q=c.length;o<q;o+=1)if(m?c[o].indexOf(l)===0:c[o]===l)return true;return false}return true}}var e={},b=["senderId","path","signal"],h=["checkSender","checkPath","checkSignal"],i=[false,true,false],j,g;e.receiverId=a.receiverId;e.path=a.path;j=0;for(g=b.length;j<g;j+=1)d(a[b[j]],h[j],i[j]);e.transformData=function(c,f){var m;if(c!==n&&typeof f==="string"&&typeof a.path==="string"&&a.path.length>f.length){m=f.length;return y(c,a.path.slice(m>0?m+1:m))}return c};return e};k.trigger=function(a){var d=
{},e=a.id,b=a.engine,h=a.processor,i=a.processorArgs,j=a.signal;d.receiveMessage=function(){var g=[],c,f=i.length;for(c=0;c<f;c+=1)g.push(b.get(i[c]));g=h.apply(n,g);b.sendMessage({senderId:e,signal:j,data:g})};b.addReceiver(e,d);return d};k.engine=function(){function a(c,f){if(typeof c!=="string")throw Error(u.receiverIdMustBeString);if(!f||typeof f!=="function"&&typeof f.receiveMessage!=="function")throw Error(u.noReceiveMessageMethod);if(c in h)throw Error(u.notUniqueReceiverId);h[c]=typeof f!==
"function"?f:{receiveMessage:f}}function d(c){if(typeof c.receiverId!=="string")throw Error(u.noReceiverId);i.push(k.rule(c))}function e(c){c.engine=b;j.push(k.trigger(c))}var b={},h={},i=[],j=[],g=[];b.addReceiver=a;b.addRule=d;b.addRules=function(){B(arguments,d)};b.addTrigger=e;b.addTriggers=function(){B(arguments,e)};b.addModel=function(c){g.push(c)};b.sendMessage=function(c){var f,m=i.length,l;for(f=0;f<m;f+=1){l=i[f];if(c.senderId!==l.receiverId)if((!l.checkSender||l.checkSender(c.senderId))&&
(!l.checkPath||l.checkPath(c.path))&&(!l.checkSignal||l.checkSignal(c.signal))){if(!(l.receiverId in h))throw Error(u.receiverNotFound);h[l.receiverId].receiveMessage({senderId:c.senderId,path:c.path,rulePath:l.path,signal:c.signal,data:l.transformData(c.data,c.path)})}}};b.get=function(c){var f,m,l;f=0;for(m=g.length;f<m;f+=1){l=g[f].get(c);if(l!==n)return l}return n};b.subscribe=function(c,f){var m=t();a(m,f);c.receiverId=m;d(c)};return b};k.validationRule=function(a){var d={},e=a.id||t(),b=a.engine,
h=a.path,i=k.validators[a.validatorName],j=a.validatorProperties||{},g;d.receiveMessage=function(c){if(c.signal==="validation-inactive")g=c.data};d.validate=function(c){if(g)return n;c=y(c,h);return i(c,j)};d.path=h;b.addReceiver(e,d);return d};k.model=function(a){function d(c,f){var m,l,o,q,s,p={},r=true;if(typeof c!=="string")c="";m=0;for(l=g.length;m<l;m+=1){o=g[m];if(!(c&&o.path.indexOf(c)!==0)){p.hasOwnProperty(o.path)||(p[o.path]=[]);q=o.validate(j);if(q!==n){p[o.path].push(q);r=false}}}if(!f)for(s in p)p.hasOwnProperty(s)&&
i.sendMessage({senderId:h,path:s,signal:"error",data:p[s]});return r}function e(c,f){i.sendMessage({senderId:h,path:c,signal:"value",data:f})}a=a||{};var b={},h=a.id||t(),i=a.engine,j={},g=[];b.receiveMessage=function(c){if(c.signal==="value"&&typeof c.path==="string"){A(j,c.path,c.data);d(c.path)}};b.set=function(){if(arguments.length===1){j=arguments[0];e("",j)}else{var c=arguments[0],f=arguments[1];A(j,c,f);e(c,f)}};b.get=function(c){if(c===n)return j;return y(j,c)};b.validate=d;(function(){var c=
(a.metadata||{}).validationRules||[],f,m=c.length,l;for(f=0;f<m;f+=1){l=c[f];g.push(k.validationRule({id:l.id,engine:i,path:l.path,validatorName:l.validatorName,validatorProperties:l.validatorProperties}))}})();i.addReceiver(h,b);i.addRule({receiverId:h,signal:"value"});i.addModel(b);return b};k.validators={};k.validators.required=function(a,d){if(a===n||a===null||typeof a==="string"&&(a===null||a===n?"":a.toString().replace(E,"").replace(F,""))===""||typeof a==="number"&&isNaN(a))return w(d.message||
k.validationMessages.required,d);return n};k.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};k.validators.minLength=function(a,d){if(a&&a.length!==n&&a.length<d.length)return w(d.message||k.validationMessages.minLenght,d);return n};k.validators.minLength.defaultProperty="length";k.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=a;return this.chain};k.validators.maxLength=function(a,d){if(a&&
a.length!==n&&a.length>d.length)return w(d.message||k.validationMessages.maxLenght,d);return n};k.validators.maxLength.defaultProperty="length";k.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};k.validators.minValue=function(a,d){if(a&&a<d.value)return w(d.message||k.validationMessages.minValue,d);return n};k.validators.minValue.defaultProperty="value";k.dsl.defaultElementProperties.minValue=function(a){this.element.validationRules.minValue=
a;return this.chain};k.validators.maxValue=function(a,d){if(a&&a>d.value)return w(d.message||k.validationMessages.maxValue,d);return n};k.validators.maxValue.defaultProperty="value";k.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};k.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",minValue:"This field should have value more that {value}!",
maxValue:"This field should have value less that {value}!"};k.changeTracker=function(){var a={},d=[],e=-1;a.push=function(b){e<d.length-1&&d.splice(e+1);d.push(b);e+=1};a.moveBack=function(){if(e>=0){e-=1;return d[e+1]}return n};a.moveForward=function(){var b=d[e+1];if(b){e+=1;return b}return n};a.getBackCount=function(){return e+1};a.getForwardCount=function(){return d.length-e-1};a.getStatus=function(){};return a};k.view=function(a){function d(g){var c=(h[g.typeName]||i)({metadata:g,engine:b}),
f,m;j[c.id]=c;if(g.elements&&g.elements.length){f=0;for(m=g.elements.length;f<m;f+=1)c.addElement(d(g.elements[f]))}return c}var e={},b=a.engine,h=a.elementTypes,i=a.defaultElementType||k.element,j={};e.element=d(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=function(g){return j[g]};return e};k.element=function(a){function d(){h.sendMessage({senderId:b.id,signal:"validation-inactive",data:b.isHidden()||b.isReadonly()});e(function(j){j.notifyValidationStatusChange()})}
function e(j){var g,c;g=0;for(c=b.elements.length;g<c;g+=1)j(b.elements[g],g)}var b={},h=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors"};b.id=a.id||t();b.properties=a.properties||{};b.elements=[];b.parent=n;b.initialize=function(){};b.addElement=function(j){b.elements.push(j);j.parent=b};b.receiveMessage=function(j){var g=i[j.signal];g&&typeof b[g]==="function"&&b[g](j.data)};b.setValue=void 0;b.notifyValueChange=function(j){var g=b.properties.binding;
if(typeof g==="string")h.sendMessage({senderId:b.id,path:g,signal:"value",data:j});else throw Error(u.elementWithoutBinding);};b.setHidden=function(j){b.hidden=j;d()};b.setReadonly=function(j){b.readonly=j;d()};b.isHidden=function(){return!!b.hidden||b.parent&&b.parent.isHidden()};b.isReadonly=function(){return!!b.readonly};b.notifyValidationStatusChange=d;b.showErrors=function(){};b.eachChild=e;h.addReceiver(b.id,b);return b};k.expressionParser=function(a){for(var d={args:[]},e=[],b=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,
h,i=a;(h=b.exec(a))!==null;){e.push(h[0]);d.args.push(h[1])}a=0;for(b=e.length;a<b;a+=1)i=i.replace(e[a],"arguments["+a+"]");d.processor=new Function("return "+i+";");return d};k.metadataProvider=function(a){function d(f,m){var l,o,q;m=m||h;m.id=f.id||t();m.typeName=f.typeName;m.properties=f.properties||{};q=m;var s,p,r,v,x,C;s=0;for(p=g.length;s<p;s+=1){r=g[s];v=f[r];if(typeof v==="string"){v=c(v);x=t();C={id:x,processorArgs:v.args,processor:v.processor,signal:r};j.push(C);i.push({receiverId:x,path:v.args,
signal:"value"});i.push({receiverId:q.id,senderId:x,signal:r})}}if(typeof f.binding==="string"){m.properties.binding=f.binding;q=m;s=f.binding;p=f.validationRules||{};for(l in p)if(p.hasOwnProperty(l)){r=k.validators[l];if(r===n)throw Error(u.unknownValidator+l);if(typeof p[l]==="object")o=p[l];else if(typeof r.defaultProperty==="string"){o={};o[r.defaultProperty]=p[l]}r=t();b.validationRules.push({id:r,path:s,validatorName:l,validatorProperties:o});i.push({receiverId:r,senderId:q.id,signal:"validation-inactive"})}i.push({receiverId:m.id,
path:f.binding,signal:["value","error"]})}if(f.elements&&f.elements.length){m.elements=[];l=0;for(o=f.elements.length;l<o;l+=1){q={};d(f.elements[l],q,m);m.elements.push(q)}}}var e={},b={validationRules:[]},h={},i=[],j=[],g=a.expressionProperties||["value","hidden","readonly"],c=a.expressionParser||k.expressionParser;e.getModelMetadata=function(){return b};e.getViewMetadata=function(){return h};e.getRules=function(){return i};e.getTriggers=function(){return j};d(a.metadata);return e};D.fe=k})(function(){return this}());
