(function(F,p){function v(){B+=1;return"i"+B}function A(a,b){var e,c,g,i;e=b.split(".");i=a;c=0;for(g=e.length;c<g;c+=1){i=i[e[c]];if(i===p||i===null)return p}return i}function C(a,b,e){b=b.split(".");var c=b.length-1,g=a;for(a=0;a<c;a+=1){g=g[b[a]];if(g===p)return}g[b[c]]=e}function D(a,b){var e,c=a.length,g,i;for(e=0;e<c;e+=1)if(typeof a[e].length==="number"){g=0;for(i=a[e].length;g<i;g+=1)b(a[e][g])}else b(a[e])}function z(a,b){var e;a=a||"";for(e in b)if(b.hasOwnProperty(e))a=a.replace(RegExp("{"+
e+"}","g"),b[e]);return a}var k={version:"0.0.1"},B=0,G=/^\s+/,H=/\s+$/,w={notUniqueReceiverId:"engine.addReceiver: recevier with given ID has been already added.",receiverIdMustBeString:"engine.addReceiver: id must be string",noReceiveMessageMethod:'engine.addReceiver: receiver should have method "receiveMessage" or be a function',noReceiverId:"engine.addRule: rule must have receiverId property, type string",receiverNotFound:"engine.sendMessage: receiver not found.",elementWithoutBinding:"element.notifyValueChange: can't send notification if binding property not defined.",
unknownValidator:"metadataProvider: unknown validator: "};k.dsl={};k.dsl.defaultElementProperties={id:function(a){this.element.id=a;return this.chain},property:function(a,b){this.element.properties[a]=b;return this.chain},label:function(a){this.element.properties.label=a;return this.chain},binding:function(a){this.element.binding=a;return this.chain},hidden:function(a){this.element.hidden=a;return this.chain},readonly:function(a){this.element.readonly=a;return this.chain},value:function(a){this.element.value=
a;return this.chain},get:function(){typeof this.params.validate==="function"&&this.params.validate.apply({element:this.element});return this.element}};k.dsl.elementConstructor=function(a,b,e){function c(g,i,l){function h(f,m){g[f]=function(){return m.apply(l,arguments)}}for(var d in i)i.hasOwnProperty(d)&&h(d,i[d])}b=b||{};b.defaultProperty=b.defaultProperty||"binding";e=e||{};return function(){function g(){var h,d=arguments.length,f;for(h=0;h<d;h+=1){f=arguments[h];if(typeof f==="function"&&typeof f.get===
"function")i.elements.push(f.get());else if(h===0&&typeof b.defaultProperty==="string")i[b.defaultProperty]=f}return g}var i={typeName:a,properties:{},validationRules:{},elements:[]},l={element:i,chain:g,params:b};typeof b.initialize==="function"&&b.initialize.apply(l);c(g,k.dsl.defaultElementProperties,l);c(g,e,l);return g.apply(p,arguments)}};k.rule=function(a){function b(d,f,m){if(d)e[f]=function(n){var r,j;if(typeof d==="string")return m?d.indexOf(n)===0:d===n;if(typeof d==="object"&&d.length){r=
0;for(j=d.length;r<j;r+=1)if(m?d[r].indexOf(n)===0:d[r]===n)return true;return false}return true}}var e={},c=["senderId","path","signal"],g=["checkSender","checkPath","checkSignal"],i=[false,true,false],l,h;e.receiverId=a.receiverId;e.path=a.path;l=0;for(h=c.length;l<h;l+=1)b(a[c[l]],g[l],i[l]);e.transformData=function(d,f){var m;if(d!==p&&typeof f==="string"&&typeof a.path==="string"&&a.path.length>f.length){m=f.length;return A(d,a.path.slice(m>0?m+1:m))}return d};return e};k.trigger=function(a){var b=
{},e=a.id,c=a.engine,g=a.processor,i=a.processorArgs,l=a.signal;b.receiveMessage=function(){var h=[],d,f=i.length;for(d=0;d<f;d+=1)h.push(c.get(i[d]));h=g.apply(p,h);c.sendMessage({senderId:e,signal:l,data:h})};c.addReceiver(e,b);return b};k.engine=function(){function a(d,f){if(typeof d!=="string")throw Error(w.receiverIdMustBeString);if(!f||typeof f!=="function"&&typeof f.receiveMessage!=="function")throw Error(w.noReceiveMessageMethod);if(d in g)throw Error(w.notUniqueReceiverId);g[d]=typeof f!==
"function"?f:{receiveMessage:f}}function b(d){if(typeof d.receiverId!=="string")throw Error(w.noReceiverId);i.push(k.rule(d))}function e(d){d.engine=c;l.push(k.trigger(d))}var c={},g={},i=[],l=[],h=[];c.addReceiver=a;c.addRule=b;c.addRules=function(){D(arguments,b)};c.addTrigger=e;c.addTriggers=function(){D(arguments,e)};c.addModel=function(d){h.push(d)};c.sendMessage=function(d){var f,m=i.length,n;for(f=0;f<m;f+=1){n=i[f];if(d.senderId!==n.receiverId)if((!n.checkSender||n.checkSender(d.senderId))&&
(!n.checkPath||n.checkPath(d.path))&&(!n.checkSignal||n.checkSignal(d.signal))){if(!(n.receiverId in g))throw Error(w.receiverNotFound);g[n.receiverId].receiveMessage({senderId:d.senderId,path:d.path,rulePath:n.path,signal:d.signal,data:n.transformData(d.data,d.path)})}}};c.get=function(d){var f,m,n;f=0;for(m=h.length;f<m;f+=1){n=h[f].get(d);if(n!==p)return n}return p};c.subscribe=function(d,f){var m=v();a(m,f);d.receiverId=m;b(d)};return c};k.validationRule=function(a){var b={},e=a.id||v(),c=a.engine,
g=a.path,i=k.validators[a.validatorName],l=a.validatorProperties||{},h;b.receiveMessage=function(d){if(d.signal==="validation-inactive")h=d.data};b.validate=function(d){if(h)return p;d=A(d,g);return i(d,l)};b.path=g;c.addReceiver(e,b);return b};k.model=function(a){function b(){if(arguments.length===1){m=arguments[0];i("",m)}else{var j=arguments[0],o=arguments[1];C(m,j,o);i(j,o)}}function e(j){if(j===p)return m;return A(m,j)}function c(j,o){var s,q,t,u,x,y={},E=true;if(typeof j!=="string")j="";s=0;
for(q=n.length;s<q;s+=1){t=n[s];if(!(j&&t.path.indexOf(j)!==0)){y.hasOwnProperty(t.path)||(y[t.path]=[]);u=t.validate(m);if(u!==p){y[t.path].push(u);E=false}}}if(!o)for(x in y)y.hasOwnProperty(x)&&f.sendMessage({senderId:d,path:x,signal:"error",data:y[x]});return E}function g(j){var o=r[{back:"moveBack",forward:"moveForward"}[j]]();if(o){b(o.path,o[{back:"oldValue",forward:"newValue"}[j]]);l(o.path)}}function i(j,o){f.sendMessage({senderId:d,path:j,signal:"value",data:o})}function l(j,o){f.sendMessage({senderId:d,
path:j,signal:"change",data:o||r.getStatus(j)})}a=a||{};var h={},d=a.id||v(),f=a.engine,m={},n=[],r=k.changeTracker();h.receiveMessage=function(j){if(j.signal==="value"&&typeof j.path==="string"){r.push({path:j.path,oldValue:e(j.path),newValue:j.data});l(j.path);C(m,j.path,j.data);c(j.path)}};h.set=b;h.get=e;h.validate=c;h.undo=function(){g("back")};h.redo=function(){g("forward")};h.getUndoCount=function(){return r.getBackCount()};h.getRedoCount=function(){return r.getForwardCount()};h.markSave=function(){var j,
o=r.markSave();for(j=0;j<o.length;j+=1)l(o[j],"saved")};(function(){var j=(a.metadata||{}).validationRules||[],o,s=j.length,q;for(o=0;o<s;o+=1){q=j[o];n.push(k.validationRule({id:q.id,engine:f,path:q.path,validatorName:q.validatorName,validatorProperties:q.validatorProperties}))}})();f.addReceiver(d,h);f.addRule({receiverId:d,signal:"value"});f.addModel(h);return h};k.validators={};k.validators.required=function(a,b){if(a===p||a===null||typeof a==="string"&&(a===null||a===p?"":a.toString().replace(G,
"").replace(H,""))===""||typeof a==="number"&&isNaN(a))return z(b.message||k.validationMessages.required,b);return p};k.dsl.defaultElementProperties.required=function(a){this.element.validationRules.required=a||true;return this.chain};k.validators.minLength=function(a,b){if(a&&a.length!==p&&a.length<b.length)return z(b.message||k.validationMessages.minLenght,b);return p};k.validators.minLength.defaultProperty="length";k.dsl.defaultElementProperties.minLength=function(a){this.element.validationRules.minLength=
a;return this.chain};k.validators.maxLength=function(a,b){if(a&&a.length!==p&&a.length>b.length)return z(b.message||k.validationMessages.maxLenght,b);return p};k.validators.maxLength.defaultProperty="length";k.dsl.defaultElementProperties.maxLength=function(a){this.element.validationRules.maxLength=a;return this.chain};k.validators.minValue=function(a,b){if(a&&a<b.value)return z(b.message||k.validationMessages.minValue,b);return p};k.validators.minValue.defaultProperty="value";k.dsl.defaultElementProperties.minValue=
function(a){this.element.validationRules.minValue=a;return this.chain};k.validators.maxValue=function(a,b){if(a&&a>b.value)return z(b.message||k.validationMessages.maxValue,b);return p};k.validators.maxValue.defaultProperty="value";k.dsl.defaultElementProperties.maxValue=function(a){this.element.validationRules.maxValue=a;return this.chain};k.validationMessages={required:"This field is required!",minLenght:"This field should contain more that {length} symbols!",maxLenght:"This field should contain less that {length} symbols!",
minValue:"This field should have value more that {value}!",maxValue:"This field should have value less that {value}!"};k.changeTracker=function(){var a={},b=[],e=-1,c=-1;a.push=function(g){e<b.length-1&&b.splice(e+1);b.push(g);e+=1};a.moveBack=function(){if(e>=0){e-=1;return b[e+1]}return p};a.moveForward=function(){var g=b[e+1];if(g){e+=1;return g}return p};a.getBackCount=function(){return e+1};a.getForwardCount=function(){return b.length-e-1};a.getStatus=function(g){var i;for(i=e;i>=0;i-=1)if(b[i].path===
g)return i<=c?"saved":"changed";return"default"};a.markSave=function(){var g,i=[];for(g=c+1;g<=e;g+=1)i.push(b[g].path);c=e;return i};return a};k.view=function(a){function b(h){var d=(g[h.typeName]||i)({metadata:h,engine:c}),f,m;l[d.id]=d;if(h.elements&&h.elements.length){f=0;for(m=h.elements.length;f<m;f+=1)d.addElement(b(h.elements[f]))}return d}var e={},c=a.engine,g=a.elementTypes,i=a.defaultElementType||k.element,l={};e.element=b(a.metadata);e.initialize=function(){e.element.initialize()};e.getElementById=
function(h){return l[h]};return e};k.element=function(a){function b(){g.sendMessage({senderId:c.id,signal:"validation-inactive",data:c.isHidden()||c.isReadonly()});e(function(l){l.notifyValidationStatusChange()})}function e(l){var h,d;h=0;for(d=c.elements.length;h<d;h+=1)l(c.elements[h],h)}var c={},g=a.engine;a=a.metadata||{};var i={value:"setValue",hidden:"setHidden",readonly:"setReadonly",error:"showErrors",change:"setStatus"};c.id=a.id||v();c.properties=a.properties||{};c.elements=[];c.parent=
p;c.initialize=function(){};c.addElement=function(l){c.elements.push(l);l.parent=c};c.receiveMessage=function(l){var h=i[l.signal];h&&typeof c[h]==="function"&&c[h](l.data)};c.setValue=void 0;c.notifyValueChange=function(l){var h=c.properties.binding;if(typeof h==="string")g.sendMessage({senderId:c.id,path:h,signal:"value",data:l});else throw Error(w.elementWithoutBinding);};c.setHidden=function(l){c.hidden=l;b()};c.setReadonly=function(l){c.readonly=l;b()};c.isHidden=function(){return!!c.hidden||
c.parent&&c.parent.isHidden()};c.isReadonly=function(){return!!c.readonly};c.notifyValidationStatusChange=b;c.showErrors=function(){};c.eachChild=e;g.addReceiver(c.id,c);return c};k.expressionParser=function(a){for(var b={args:[]},e=[],c=/\:([a-zA-Z_\$][\w\$]*(?:\.?[a-zA-Z_\$][\w\$]*)+)/g,g,i=a;(g=c.exec(a))!==null;){e.push(g[0]);b.args.push(g[1])}a=0;for(c=e.length;a<c;a+=1)i=i.replace(e[a],"arguments["+a+"]");b.processor=new Function("return "+i+";");return b};k.metadataProvider=function(a){function b(f,
m){var n,r,j;m=m||g;m.id=f.id||v();m.typeName=f.typeName;m.properties=f.properties||{};j=m;var o,s,q,t,u,x;o=0;for(s=h.length;o<s;o+=1){q=h[o];t=f[q];if(typeof t==="string"){t=d(t);u=v();x={id:u,processorArgs:t.args,processor:t.processor,signal:q};l.push(x);i.push({receiverId:u,path:t.args,signal:"value"});i.push({receiverId:j.id,senderId:u,signal:q})}}if(typeof f.binding==="string"){m.properties.binding=f.binding;j=m;o=f.binding;s=f.validationRules||{};for(n in s)if(s.hasOwnProperty(n)){q=k.validators[n];
if(q===p)throw Error(w.unknownValidator+n);if(typeof s[n]==="object")r=s[n];else if(typeof q.defaultProperty==="string"){r={};r[q.defaultProperty]=s[n]}q=v();c.validationRules.push({id:q,path:o,validatorName:n,validatorProperties:r});i.push({receiverId:q,senderId:j.id,signal:"validation-inactive"})}i.push({receiverId:m.id,path:f.binding,signal:["value","error","change"]})}if(f.elements&&f.elements.length){m.elements=[];n=0;for(r=f.elements.length;n<r;n+=1){j={};b(f.elements[n],j,m);m.elements.push(j)}}}
var e={},c={validationRules:[]},g={},i=[],l=[],h=a.expressionProperties||["value","hidden","readonly"],d=a.expressionParser||k.expressionParser;e.getModelMetadata=function(){return c};e.getViewMetadata=function(){return g};e.getRules=function(){return i};e.getTriggers=function(){return l};b(a.metadata);return e};F.fe=k})(function(){return this}());
